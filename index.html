<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Tu Supermercado Mayorista</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f8f8;
            color: #333;
        }
        /* Custom styles for hamburger menu icon */
        .hamburger {
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            width: 24px;
            height: 24px;
            padding: 0;
            background: transparent;
            border: none;
            z-index: 50;
        }
        .hamburger span {
            display: block;
            width: 100%;
            height: 3px;
            background-color: #333;
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        .hamburger.open span:nth-child(1) {
            transform: translateY(10px) rotate(45deg);
        }
        .hamburger.open span:nth-child(2) {
            opacity: 0;
        }
        .hamburger.open span:nth-child(3) {
            transform: translateY(-10px) rotate(-45deg);
        }

        /* Sidebar styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: -280px; /* Hidden by default */
            width: 280px;
            height: 100%;
            background-color: #fff;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
            transition: left 0.3s ease-in-out;
            z-index: 40;
            padding: 20px;
            overflow-y: auto;
        }
        .sidebar.open {
            left: 0; /* Visible when open */
        }
        .sidebar .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #555;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 30;
            display: none;
        }

        /* Hero section specific styles */
        .hero-banner {
            background: url('https://static.cotodigital3.com.ar/sitios/cdigi/static/content/images/cdigi/ofertas/cartridge/nuevahome/2025-01/images/cepas060625.jpg') no-repeat center center/cover;
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }

        /* Category Card (Mobile view, Pill style) */
        .category-card {
            background-color: #f0f4f8; /* Very light blue-gray */
            color: #4a5568; /* Darker gray */
            padding: 0.5rem 1rem; /* Reduced padding */
            border-radius: 9999px; /* Pill shape */
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; /* Simpler transition */
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #cbd5e0; /* Light border */
            flex-shrink: 0; /* Prevent shrinking when in a scrollable container */
        }
        .category-card:hover {
            background-color: #e2e8f0; /* Slightly darker on hover */
        }
        .category-card.active {
            background-color: #3b82f6; /* Blue 600 */
            color: white;
            border-color: #3b82f6; /* Matching border */
        }

        /* Main Category Link (Desktop view, Text link style in new section) */
        .main-category-link {
            padding: 0.5rem 0.75rem;
            color: #333;
            font-weight: 500;
            text-decoration: none;
            position: relative;
            transition: color 0.3s ease;
            white-space: nowrap; /* Prevent wrapping */
        }
        .main-category-link:hover {
            color: #3b82f6; /* Blue 600 */
        }
        .main-category-link.active {
            color: #1d4ed8; /* Darker blue */
            font-weight: 600;
        }
        .main-category-link.active::after {
            content: '';
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: -5px; /* Adjust as needed */
            width: calc(100% - 1.5rem); /* Adjust based on padding */
            height: 3px;
            background-color: #1d4ed8; /* Darker blue */
            border-radius: 2px;
        }
        /* Separator for desktop main category links */
        .main-category-link + .nav-separator {
            color: #ccc; /* Light gray */
            padding: 0 0.5rem;
            font-size: 1.25rem;
            align-self: center;
        }

        /* Subcategory pills (used in product view) */
        .subcategory-pill {
            background-color: #f0f4f8; /* Light gray-blue */
            color: #4a5568; /* Darker gray */
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 1px solid #cbd5e0; /* border-gray-300 */
            white-space: nowrap; /* Prevent wrapping */
        }
        .subcategory-pill:hover {
            background-color: #e2e8f0; /* Slightly darker on hover */
            transform: translateY(-1px);
        }
        .subcategory-pill.active {
            background-color: #3b82f6; /* Blue 600 */
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3);
        }

        /* General styles for product view */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        /* Desktop: Force 4 columns on large screens */
        @media (min-width: 1024px) { /* Equivalent to Tailwind's lg: breakpoint */
            .product-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Responsive adjustments for categories section on smaller screens */
        @media (max-width: 767px) {
            .desktop-only {
                display: none;
            }
            .mobile-only {
                display: block;
            }
            /* Hide scrollbar for mobile categories */
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;  /* IE and Edge */
                scrollbar-width: none;  /* Firefox */
            }
        }
        @media (min-width: 768px) {
            .mobile-only {
                display: none;
            }
            .desktop-only {
                display: block;
            }
        }

        /* Custom styles for floating cart button */
        .floating-cart-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #3b82f6; /* Blue 600 */
            color: white;
            border-radius: 9999px; /* Fully rounded */
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 9999; /* Increased z-index to prevent collision */
            transition: all 0.3s ease;
        }
        .floating-cart-button:hover {
            background-color: #1d4ed8; /* Darker blue */
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0,0,0,0.15);
        }

        /* Notification message styles */
        #notification-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100%); /* Start off-screen */
            z-index: 100;
            padding: 1rem 2rem;
            border-radius: 9999px; /* Pill shape */
            font-weight: 600;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        #notification-message.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Styles for the progress bar (simple text based) */
        .progress-indicator {
            font-size: 0.9rem;
            color: #6b7280; /* gray-500 */
            margin-top: 5px;
            text-align: center;
        }

        /* Styles for individual product cards (consistent height) */
        .product-card-item {
            min-height: 480px; /* Increased min-height to accommodate more content and ensure vertical alignment */
        }

        /* Container for product title and sort filter (New structure for alignment) */
        .product-header-controls {
            display: flex;
            flex-direction: column; /* Stack on small screens */
            justify-content: space-between;
            align-items: center; /* Center items for single column */
            margin-bottom: 1.5rem; /* Equivalent to mb-6 */
        }
        @media (min-width: 640px) { /* sm breakpoint */
            .product-header-controls {
                flex-direction: row; /* Row on larger screens */
                align-items: center;
            }
        }

        /* Styles for the custom sort dropdown */
        .sort-dropdown-container {
            position: relative; /* Essential for absolute positioning of dropdown content */
            display: flex; /* Use flex for icon and button */
            align-items: center;
            gap: 0.5rem; /* Space between icon and button */
            margin-top: 1rem; /* Space from title on mobile */
        }
        @media (min-width: 640px) { /* sm breakpoint */
            .sort-dropdown-container {
                margin-top: 0; /* No top margin on desktop */
            }
        }

        #sort-filter-toggle {
            cursor: pointer;
            outline: none;
            width: auto; /* Allow content to dictate width */
            min-width: 150px; /* Maintain a minimum width for the button */
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #sort-filter-dropdown {
            position: absolute;
            right: 0; /* Align to the right of its parent container */
            top: 100%; /* Position below the toggle button */
            margin-top: 0.5rem; /* Space between button and dropdown */
            width: 200px; /* Fixed width for dropdown */
            background-color: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 30; /* Ensure it's above other content */
        }

        /* Style for filter radio button labels */
        #sort-filter-dropdown label {
            padding: 0.5rem 1rem;
            display: flex; /* Use flex for alignment of radio and text */
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        #sort-filter-dropdown label:hover {
            background-color: #f0f4f8; /* Light hover background */
        }
        #sort-filter-dropdown input[type="radio"] {
            margin-right: 0.5rem;
            /* Optional: custom radio button styling */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div id="notification-message" class="hidden"></div>

    <header class="bg-white shadow-md p-4 flex justify-between items-center relative z-20">
        <button class="hamburger" id="hamburger-menu">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <h1 class="text-xl font-bold">Tu Supermercado Mayorista</h1>
        <div class="flex items-center space-x-4">
            <div class="relative flex items-center">
                <button class="text-gray-600 hover:text-gray-900 focus:outline-none" id="search-toggle-button">
                    <i class="fas fa-search"></i>
                </button>
                <input type="search" id="search-input" placeholder="Buscar productos..."
                       class="absolute right-0 top-1/2 -translate-y-1/2 w-48 p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500
                              opacity-0 pointer-events-none transition-all duration-300 ease-in-out
                              lg:static lg:translate-y-0 lg:w-auto lg:opacity-100 lg:pointer-events-auto lg:ml-4">
            </div>
            <button class="text-gray-600 hover:text-gray-900 focus:outline-none" id="cart-button">
                <i class="fas fa-shopping-cart"></i>
                <span id="cart-count" class="bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center -ml-2 -mt-2 absolute top-4 right-4 sm:static">0</span>
            </button>
        </div>
    </header>

    <nav class="sidebar" id="sidebar">
        <button class="close-btn" id="close-sidebar">&times;</button>
        <ul class="space-y-4 pt-10">
            <li><a href="#" class="block text-lg font-semibold text-gray-700 hover:text-blue-600" onclick="filterProductsByCategory('Inicio'); closeSidebar();">Inicio</a></li>
            <li><a href="#" class="block text-lg font-semibold text-gray-700 hover:text-blue-600" onclick="filterProductsByCategory('Los más vendidos'); closeSidebar();">Los más vendidos</a></li>
            <li><a href="#" class="block text-lg font-semibold text-gray-700 hover:text-blue-600">Ofertas</a></li>
            <li class="border-t border-gray-200 pt-4 mt-4">
                <h4 class="text-md font-semibold mb-2 text-gray-600">Categorías de Productos</h4>
                <div id="sidebar-categories-list" class="space-y-2">
                    </div>
            </li>
            <li><a href="#" class="block text-lg font-semibold text-gray-700 hover:text-blue-600">Contacto</a></li>
            <li><a href="#" class="block text-lg font-semibold text-gray-700 hover:text-blue-600">Mi Cuenta</a></li>
            <li class="border-t border-gray-200 pt-4 mt-4">
                <button id="upload-products-btn" class="w-full bg-green-500 text-white py-2 rounded-md hover:bg-green-600 transition-colors duration-200 text-sm font-semibold">
                    Cargar Productos Aleatorios (Firestore)
                </button>
            </li>
        </ul>
    </nav>

    <div class="overlay" id="overlay"></div>

    <main class="flex-grow">
        <section class="hero-banner h-48 sm:h-64 md:h-80 flex items-center justify-center text-center p-4">
            <div class="container mx-auto">
                </div>
        </section>

        <section class="mobile-only p-4">
            <h3 class="text-xl font-semibold mb-4 text-center">Explora Nuestras Categorías</h3>
            <div id="mobile-categories-container" class="flex overflow-x-auto whitespace-nowrap justify-start gap-2 pb-2 scrollbar-hide">
                </div>
        </section>

        <section class="desktop-only p-4 bg-white shadow-sm">
            <div class="container mx-auto flex justify-center items-center overflow-x-auto whitespace-nowrap py-2 scrollbar-hide">
                <nav class="flex space-x-1">
                    <div id="desktop-main-categories-container" class="flex"></div>
                </nav>
            </div>
        </section>

        <section class="p-4 sm:p-6 lg:p-8">
            <div class="container mx-auto">
                <div class="product-header-controls">
                    <h3 id="product-section-title" class="text-2xl font-bold text-center sm:text-left mb-4 sm:mb-0">Nuestros Productos</h3>
                    <div class="sort-dropdown-container">
                        <i class="fas fa-sort text-gray-600 text-lg"></i> <button id="sort-filter-toggle" class="px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                            <span>Ordenar por: <span id="current-sort-display" class="font-normal text-gray-600">Defecto</span></span>
                            <i class="fas fa-chevron-down ml-2 text-gray-500"></i> </button>
                        <div id="sort-filter-dropdown" class="absolute top-full right-0 mt-2 w-48 bg-white border border-gray-300 rounded-md shadow-lg z-30 hidden">
                            <div class="p-2">
                                <label class="block cursor-pointer py-1 px-3 hover:bg-gray-100">
                                    <input type="radio" name="sortOrder" value="default" class="mr-2" onchange="setSortOrder(this.value)">
                                    <span>Defecto</span>
                                </label>
                                <label class="block cursor-pointer py-1 px-3 hover:bg-gray-100">
                                    <input type="radio" name="sortOrder" value="alpha_asc" class="mr-2" onchange="setSortOrder(this.value)">
                                    <span>A-Z</span>
                                </label>
                                <label class="block cursor-pointer py-1 px-3 hover:bg-gray-100">
                                    <input type="radio" name="sortOrder" value="alpha_desc" class="mr-2" onchange="setSortOrder(this.value)">
                                    <span>Z-A</span>
                                </label>
                                <label class="block cursor-pointer py-1 px-3 hover:bg-gray-100">
                                    <input type="radio" name="sortOrder" value="price_asc" class="mr-2" onchange="setSortOrder(this.value)">
                                    <span>Precio Menor</span>
                                </label>
                                <label class="block cursor-pointer py-1 px-3 hover:bg-gray-100">
                                    <input type="radio" name="sortOrder" value="price_desc" class="mr-2" onchange="setSortOrder(this.value)">
                                    <span>Precio Mayor</span>
                                </label>
                                <label class="block cursor-pointer py-1 px-3 hover:bg-gray-100">
                                    <input type="radio" name="sortOrder" value="discount_desc" class="mr-2" onchange="setSortOrder(this.value)">
                                    <span>Descuento</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="subcategory-pills-container" class="flex flex-wrap justify-center gap-2 mb-6 hidden">
                    </div>

                <div id="product-display-container" class="product-grid">
                    <p id="loading-products-message" class="text-center text-gray-500 col-span-full">Cargando productos...</p>
                    </div>
                <p id="no-products-message" class="text-center text-gray-500 hidden mt-8 col-span-full">No se encontraron productos que coincidan con tu búsqueda.</p>
                <div id="view-more-products-container" class="mt-8 text-center">
                    </div>
            </div>
        </section>
    </main>

    <button id="floating-cart-button" class="floating-cart-button">
        <i class="fas fa-shopping-cart"></i>
    </button>

    <div id="customModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h4 id="modalTitle" class="text-xl font-bold">Título del Modal</h4>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="modalBody" class="text-gray-700 mb-6 max-h-80 overflow-y-auto">
                </div>
            <div id="modalFooter" class="flex justify-end space-x-4">
                </div>
        </div>
    </div>

    <script type="module">
        // Variables globales para la configuración de Firebase y autenticación
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
        ? JSON.parse(__firebase_config) 
        : 
    {
    apiKey: "AIzaSyDWxVB7bKW4JKbZSC2wab_M2Z6J6LnNBu8",
    authDomain: "misuperappmayorista.firebaseapp.com",
    projectId: "misuperappmayorista",
    storageBucket: "misuperappmayorista.firebasestorage.app",
    messagingSenderId: "926853864100",
    appId: "1:926853864100:web:b825e3636bfaa1ea6da431",
    measurementId: "G-DHCNRHC3NQ"};

        // Importa los módulos de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Ya no se importan getFunctions o httpsCallable porque se eliminó la generación de descripción por IA.

        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // userId por defecto
        let isAuthReady = false; // Bandera para indicar si el estado de autenticación está listo

        let products = []; // Aquí se guardarán los productos obtenidos de Firestore
        let cart = [];
        const cartCountElement = document.getElementById('cart-count');
        const productListElement = document.getElementById('product-display-container');
        const mobileCategoriesContainer = document.getElementById('mobile-categories-container');
        const desktopMainCategoriesContainer = document.getElementById('desktop-main-categories-container');
        const subcategoryPillsContainer = document.getElementById('subcategory-pills-container');
        const notificationMessageElement = document.getElementById('notification-message');
        const productSectionTitle = document.getElementById('product-section-title');
        const noProductsMessage = document.getElementById('no-products-message');
        const sidebarCategoriesList = document.getElementById('sidebar-categories-list'); // Elemento para las categorías de la barra lateral
        const viewMoreProductsContainer = document.getElementById('view-more-products-container'); // Contenedor para el botón "VER MÁS PRODUCTOS"
        const loadingProductsMessage = document.getElementById('loading-products-message'); // Mensaje de carga para productos

        // Elementos del modal
        const customModal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const modalFooter = document.getElementById('modalFooter');
        const closeModalBtn = document.getElementById('closeModalBtn');

        // Elementos de búsqueda
        const searchToggleButton = document.getElementById('search-toggle-button');
        const searchInput = document.getElementById('search-input');
        
        // Elementos de filtro (ordenar)
        const sortFilterToggle = document.getElementById('sort-filter-toggle');
        const sortFilterDropdown = document.getElementById('sort-filter-dropdown');
        const currentSortDisplay = document.getElementById('current-sort-display');

        // Botón de carga de productos
        const uploadProductsBtn = document.getElementById('upload-products-btn');

        // Variables de estado para el proceso de pago
        let checkoutData = {};
        let currentStep = 0; // 0 para la vista del carrito, 1-4 para los pasos de pago
        const totalSteps = 4; // Número total de pasos del proceso de pago

        // Estados globales de filtro y paginación
        let activeCategory = 'Inicio'; // Filtro predeterminado al cargar
        let activeSubcategory = 'Todos'; // Filtro predeterminado
        let currentSearchQuery = ''; // Valor actual del campo de búsqueda
        let isDesktopCategoriesExpanded = false; // Estado para controlar la expansión de la barra de categorías en escritorio

        let productsPerPage = 12; // Predeterminado para categorías normales (3 filas * 4 columnas)
        let initialHomeAndBestsellersLimit = 8; // Para 'Inicio' y 'Los más vendidos' (2 filas * 4 columnas)
        let bestsellersLimit = 4; // Para 'Los más vendidos'
        let currentProductsDisplayedCount = 0; // Rastrea cuántos productos se muestran actualmente en la sección principal
        let currentSortOrder = 'default'; // 'default', 'alpha_asc', 'alpha_desc', 'price_asc', 'price_desc', 'discount_desc'


        // --- Inicialización y Autenticación de Firebase ---
        window.onload = async function() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Iniciar sesión de forma anónima o con un token personalizado
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // Escuchar cambios en el estado de autenticación
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid; // Actualizar userId
                        console.log("Firebase user authenticated:", userId);
                    } else {
                        userId = crypto.randomUUID(); // ID de usuario anónimo
                        console.log("Firebase user is anonymous:", userId);
                    }
                    isAuthReady = true; // El estado de autenticación está listo
                    // Ahora es seguro configurar los listeners de Firestore
                    setupCartListener(userId);
                    setupProductsListener(); // Escuchar los datos de productos de Firestore
                });

                // Visualización inicial de elementos (se actualizará una vez que los productos se carguen de Firestore)
                displayCategories();
                updateSortDisplay(); // Inicializar el texto de visualización de ordenación

            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                // Fallback: mostrar productos sin Firebase si ocurre un error
                displayCategories();
                updateSortDisplay(); // Inicializar el texto de visualización de ordenación
                showModal("Error de Conexión", "No se pudo conectar con los servicios de Firebase. Algunas funcionalidades pueden no estar disponibles.", [{ text: "Entendido", action: "close" }]);
            }
        };

        // --- Listener de Carrito de Firebase ---
        function setupCartListener(currentUserId) {
            // Asegúrate de que el userId no sea 'anonymous' y la base de datos esté lista
            if (!db || !currentUserId || currentUserId === 'anonymous') {
                console.warn("Firestore o User ID no están listos para el carrito.");
                return;
            }
            const cartCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/cart`);
            onSnapshot(cartCollectionRef, (snapshot) => {
                cart = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateCartCount();
                console.log("Cart updated from Firestore:", cart);
                // Si el modal del carrito está abierto y es la vista del carrito, actualizar su contenido
                if (!customModal.classList.contains('hidden') && currentStep === 0) {
                    displayCartContents();
                }
            }, (error) => {
                console.error("Error listening to cart changes:", error);
                showModal("Error del Carrito", `No se pudieron cargar los datos del carrito en tiempo real. Error: ${error.message}`, [{ text: "Cerrar", action: "close" }]);
            });
        }

        // --- Listener de Productos de Firebase ---
        function setupProductsListener() {
            if (!db || !isAuthReady) {
                console.warn("Firestore o Auth no listos, no se puede configurar el listener de productos.");
                return;
            }
            loadingProductsMessage.classList.remove('hidden');
            const productsCollectionRef = collection(db, `artifacts/${appId}/public/data/products`);
            onSnapshot(productsCollectionRef, (snapshot) => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Products loaded from Firestore:", products.length);
                // Recalcular categorías y subcategorías basadas en los productos obtenidos
                allProductCategories = [...new Set(products.map(p => p.category))].sort();
                // Asegúrate de que subcategories también se extraiga de forma robusta
                subcategories = [...new Set(products.flatMap(p => p.subcategory ? [p.subcategory] : []))];
                displayCategories(); // Actualizar categorías en la UI
                renderProductsBasedOnFiltersAndSearch(); // Renderizar productos una vez cargados
                loadingProductsMessage.classList.add('hidden'); // Ocultar mensaje de carga
            }, (error) => {
                console.error("Error listening to products changes:", error);
                showModal("Error de Productos", "No se pudieron cargar los productos en tiempo real. Por favor, recarga la página.", [{ text: "Cerrar", action: "close" }]);
                loadingProductsMessage.classList.add('hidden'); // Ocultar mensaje de carga incluso si hay error
            });
        }


        // --- Funciones Auxiliares de UI ---

        // Función genérica para mostrar modales (utilizada para confirmaciones y errores)
        function showModal(title, bodyHtml, buttons) {
            modalTitle.innerHTML = title;
            modalBody.innerHTML = bodyHtml;
            modalFooter.innerHTML = ''; // Limpiar botones anteriores

            buttons.forEach(btn => {
                const buttonElement = document.createElement('button');
                buttonElement.textContent = btn.text;
                buttonElement.className = 'px-4 py-2 rounded-md transition-colors duration-200';
                if (btn.action === 'close') {
                    buttonElement.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                    buttonElement.onclick = () => customModal.classList.add('hidden');
                } else if (btn.action === 'confirm') {
                    buttonElement.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                    buttonElement.onclick = () => {
                        btn.callback(); // Ejecutar callback
                        customModal.classList.add('hidden'); // Cerrar después de la acción
                    };
                } else if (btn.action === 'custom') {
                    // Aplicar text-white para botones personalizados según lo solicitado
                    buttonElement.classList.add(btn.className || 'bg-blue-600', btn.color || 'text-white', btn.hover || 'hover:bg-blue-700');
                    buttonElement.onclick = () => {
                        if (btn.callback) btn.callback();
                        // El modal no se cierra por defecto para acciones personalizadas, a menos que el callback lo maneje
                    };
                }
                modalFooter.appendChild(buttonElement);
            });

            customModal.classList.remove('hidden');
        }

        // Listener del botón para cerrar el modal
        closeModalBtn.addEventListener('click', () => {
            customModal.classList.add('hidden');
            currentStep = 0; // Reiniciar el proceso de pago if the modal is closed manually
        });

        // Función para mostrar notificaciones temporales
        function showNotification(message, type = 'info') {
            notificationMessageElement.textContent = message;
            notificationMessageElement.classList.remove('hidden', 'bg-red-200', 'text-red-800', 'bg-green-200', 'text-green-800', 'bg-blue-200', 'text-blue-800');
            
            if (type === 'success') {
                notificationMessageElement.classList.add('bg-green-200', 'text-green-800');
            } else if (type === 'error') {
                notificationMessageElement.classList.add('bg-red-200', 'text-red-800');
            } else if (type === 'info') {
                notificationMessageElement.classList.add('bg-blue-200', 'text-blue-800');
            }

            // Activar la animación de mostrar
            notificationMessageElement.classList.add('show');

            setTimeout(() => {
                // Activar la animación de ocultar
                notificationMessageElement.classList.remove('show');
                setTimeout(() => {
                    notificationMessageElement.classList.add('hidden'); // Ocultar completamente después de la transición
                }, 300); // Coincidir con la duración de la transición
            }, 1000); // Mostrar durante 1 segundo
        }


        // --- Visualización de Categorías ---
        let allProductCategories = []; // Se poblará desde Firestore
        let subcategories = []; // Se poblará desde Firestore

        function displayCategories() {
            const specialCategories = ['Inicio', 'Los más vendidos'];
            const allCategoriesForMobileDisplay = [...specialCategories, ...allProductCategories, 'Todos'];

            // Categorías para móvil (Pills)
            mobileCategoriesContainer.innerHTML = '';
            allCategoriesForMobileDisplay.forEach(category => {
                const button = document.createElement('button');
                button.textContent = category;
                button.className = `category-card ${activeCategory === category ? 'active' : ''}`;
                button.onclick = () => filterProductsByCategory(category);
                mobileCategoriesContainer.appendChild(button);
            });

            // Categorías principales de escritorio (Enlaces)
            desktopMainCategoriesContainer.innerHTML = '';
            let categoriesToDisplayInDesktopNav = [];

            if (isDesktopCategoriesExpanded) {
                categoriesToDisplayInDesktopNav = [...specialCategories, ...allProductCategories, 'Todos'];
            } else {
                categoriesToDisplayInDesktopNav = [...specialCategories, ...allProductCategories.slice(0, 3)];
            }
            
            categoriesToDisplayInDesktopNav.forEach((category, index) => {
                const link = document.createElement('a');
                link.href = '#';
                link.textContent = category;
                link.className = `main-category-link ${activeCategory === category ? 'active' : ''}`;
                link.onclick = (e) => {
                    e.preventDefault();
                    isDesktopCategoriesExpanded = false; // Colapsar cuando se elige una categoría específica
                    filterProductsByCategory(category);
                };
                desktopMainCategoriesContainer.appendChild(link);
                if (index < categoriesToDisplayInDesktopNav.length - 1) {
                    const separator = document.createElement('span');
                    separator.textContent = '|';
                    separator.className = 'nav-separator';
                    desktopMainCategoriesContainer.appendChild(separator);
                }
            });

            // Agregar botón 'Ver Más Categorías' si no está expandido y hay más categorías de productos
            if (!isDesktopCategoriesExpanded && allProductCategories.length > 3) {
                if (categoriesToDisplayInDesktopNav.length > 0) {
                    const separator = document.createElement('span');
                    separator.textContent = '|';
                    separator.className = 'nav-separator';
                    desktopMainCategoriesContainer.appendChild(separator);
                }
                const link = document.createElement('a');
                link.href = '#';
                link.textContent = 'Ver Más Categorías';
                link.className = `main-category-link`;
                link.onclick = (e) => {
                    e.preventDefault();
                    isDesktopCategoriesExpanded = true;
                    displayCategories(); // Volver a renderizar para mostrar todas las categorías de escritorio
                };
                desktopMainCategoriesContainer.appendChild(link);
            }


            // Lista de Categorías de la barra lateral
            sidebarCategoriesList.innerHTML = '';
            const visibleSidebarCategories = allProductCategories.slice(0, 5); // Mostrar las primeras 5 categorías en la barra lateral
            visibleSidebarCategories.forEach(category => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<a href="#" class="block text-md font-medium text-gray-700 hover:text-blue-600" onclick="filterProductsByCategory('${category}'); closeSidebar();">${category}</a>`;
                sidebarCategoriesList.appendChild(listItem);
            });
            if (allProductCategories.length > 5) {
                const seeAllLi = document.createElement('li');
                seeAllLi.innerHTML = `<a href="#" class="block text-md font-semibold text-blue-600 hover:text-blue-700 mt-2" onclick="filterProductsByCategory('Todos'); closeSidebar();">Ver Todas las Categorías</a>`;
                sidebarCategoriesList.appendChild(seeAllLi);
            }
        }

        window.closeSidebar = function() { // Hecho global para onclick en HTML
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('hamburger-menu').classList.remove('open');
        }

        // --- Visualización de Subcategorías ---
        function displaySubcategories() {
            subcategoryPillsContainer.innerHTML = '';
            let filteredSubcategories = [];
            const isSpecificCategorySelected = !['Inicio', 'Los más vendidos', 'Todos'].includes(activeCategory);

            if (isSpecificCategorySelected) {
                filteredSubcategories = ['Todos', ...new Set(products.filter(p => p.category === activeCategory).map(p => p.subcategory))];
            } else {
                filteredSubcategories = [];
            }

            if (filteredSubcategories.length === 0 || (filteredSubcategories.length === 1 && filteredSubcategories[0] === 'Todos')) {
                subcategoryPillsContainer.classList.add('hidden');
            } else {
                subcategoryPillsContainer.classList.remove('hidden');
            }

            filteredSubcategories.forEach(sub => {
                const button = document.createElement('button');
                button.textContent = sub;
                button.className = `subcategory-pill ${activeSubcategory === sub ? 'active' : ''}`;
                button.onclick = () => filterProductsBySubcategory(sub);
                subcategoryPillsContainer.appendChild(button);
            });
        }

        // --- Función de Formato de Precios ---
        function formatPrice(price) {
            // Verifica si price es un número válido. Si no lo es, devuelve un mensaje o un valor por defecto.
            if (typeof price === 'number' && !isNaN(price)) {
                return price.toLocaleString('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            } else {
                // Loguea una advertencia en la consola, pero no rompe la UI
                console.warn("Advertencia: El precio del producto no es un número válido y no se puede formatear:", price);
                return "N/A"; // Retorna un valor por defecto para no romper la interfaz
            }
        }

        // --- Visualización de Productos ---
        function displayProducts(productsToDisplay) {
            productListElement.innerHTML = ''; // Limpiar contenido anterior
            noProductsMessage.classList.add('hidden'); // Ocultar mensaje de no productos por defecto

            if (productsToDisplay.length === 0 && !loadingProductsMessage.classList.contains('hidden')) {
                // Si no hay productos y el mensaje de carga es visible, no mostrar el mensaje de "no productos" todavía
                return;
            } else if (productsToDisplay.length === 0) {
                productListElement.innerHTML = '';
                noProductsMessage.classList.remove('hidden');
                return;
            }

            productListElement.classList.add('product-grid'); // Asegurar que la clase de cuadrícula esté presente

            productsToDisplay.forEach(product => {
                const productInCart = cart.find(item => item.productId === product.id);
                const quantityInCart = productInCart ? productInCart.quantity : 0;

                const productCard = document.createElement('div');
                // Usar flex-col y justify-between para empujar el contenido hacia abajo
                productCard.className = `bg-white rounded-lg shadow-md overflow-hidden transform transition duration-300 hover:scale-105 flex flex-col product-card-item max-w-sm`;
                productCard.innerHTML = `
                    <img src="${product.imageUrl}" alt="${product.name}" class="w-full h-48 object-cover">
                    <div class="p-4 flex-grow flex flex-col justify-between">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-2">${product.name}</h4>
                            <p class="text-gray-600 text-sm mb-3 h-10 overflow-hidden line-clamp-2">${product.description || 'Descripción no disponible.'}</p>
                        </div>
                        <div>
                            <div class="flex flex-col mb-4">
                                <div class="flex items-baseline">
                                    <span class="product-price-display" id="wholesale-price-display-${product.id}">
                                        $${formatPrice(product.wholesalePrice || 0)}
                                    </span>
                                    <span class="ml-2 text-sm text-gray-500" id="wholesale-note-${product.id}">
                                        Mayorista
                                    </span>
                                </div>

                                <div class="flex items-baseline mt-1">
                                    <span class="product-price-display" id="unit-price-display-${product.id}">
                                        $${formatPrice(product.unitPrice || 0)}
                                    </span>
                                    <span class="ml-2 text-sm text-gray-500" id="unit-note-${product.id}">
                                        por unidad
                                    </span>
                                </div>

                                <p id="price-message-${product.id}" class="text-sm mt-2"></p>

                                <p class="text-xs text-gray-700 mt-2">
                                    <span class="font-semibold">Mayorista:</span> a partir de ${product.wholesaleQuantity || 0} unidades.
                                </p>
                            </div>
                            <div class="flex items-center justify-between mt-auto">
                                <div class="flex items-center border border-gray-300 rounded-md flex-shrink-0">
                                    <button class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-l-md" onclick="updateQuantity('${product.id}', -1)">-</button>
                                    <input type="number" id="qty-${product.id}" value="${quantityInCart}" min="0" class="w-16 text-center border-x border-gray-300 appearance-none [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none focus:outline-none" onchange="manualQuantityUpdate('${product.id}', this.value)">
                                    <button class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-r-md" onclick="updateQuantity('${product.id}', 1)">+</button>
                                </div>
                                <button class="ml-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200 flex-shrink-0" onclick="addToCart('${product.id}')">
                                    Añadir
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                productListElement.appendChild(productCard);
                updateDisplayedPrice(product.id);
            });
        }

        // --- Lógica de Filtrado y Ordenación ---
        function filterProductsByCategory(category) {
            currentSearchQuery = '';
            searchInput.value = '';
            activeSubcategory = 'Todos';
            activeCategory = category;
            isDesktopCategoriesExpanded = false; // Colapsar categorías de escritorio al cambiar de categoría

            resetPagination(); // Reiniciar paginación al cambiar de categoría
            displayCategories();
            displaySubcategories();
            renderProductsBasedOnFiltersAndSearch();
        }

        function filterProductsBySubcategory(subcategory) {
            activeSubcategory = subcategory;
            currentSearchQuery = '';
            searchInput.value = '';
            resetPagination(); // Reiniciar paginación al cambiar de subcategoría
            displaySubcategories();
            renderProductsBasedOnFiltersAndSearch();
        }

        window.setSortOrder = function(order) {
            currentSortOrder = order;
            updateSortDisplay(); // Actualizar el texto en la etiqueta de resumen
            resetPagination(); // Reiniciar paginación al cambiar el orden de clasificación
            renderProductsBasedOnFiltersAndSearch();
            sortFilterDropdown.classList.add('hidden'); // Cerrar el menú desplegable después de la selección
        }

        function updateSortDisplay() {
            let displayText = 'Defecto';
            switch (currentSortOrder) {
                case 'alpha_asc': displayText = 'A-Z'; break;
                case 'alpha_desc': displayText = 'Z-A'; break;
                case 'price_asc': displayText = 'Precio Menor'; break;
                case 'price_desc': displayText = 'Precio Mayor'; break;
                case 'discount_desc': displayText = 'Descuento'; break;
            }
            currentSortDisplay.textContent = displayText;
            // Asegurarse de que el botón de radio esté marcado
            const radio = document.querySelector(`input[name="sortOrder"][value="${currentSortOrder}"]`);
            if (radio) {
                radio.checked = true;
            }
        }


        function resetPagination() {
            currentProductsDisplayedCount = 0; // Reiniciar para mostrar el lote inicial
        }

        function renderProductsBasedOnFiltersAndSearch() {
            let filteredProducts = products;
            let sectionTitle = "Nuestros Productos";
            let limitForDisplay = null; // Sin límite por defecto para categorías normales
            
            // 1. Aplicar filtro de búsqueda
            if (currentSearchQuery) {
                filteredProducts = products.filter(p => p.name.toLowerCase().includes(currentSearchQuery.toLowerCase()) ||
                                               (p.description || '').toLowerCase().includes(currentSearchQuery.toLowerCase())); // Safe access to description
                sectionTitle = `Resultados para "${currentSearchQuery}"`;
                // Subcategorías ocultas al buscar
                subcategoryPillsContainer.classList.add('hidden');
            } else {
                // 2. Aplicar filtro de Categoría/Subcategoría
                if (activeCategory === 'Inicio') {
                    // Para Inicio, mostrar un número limitado de productos
                    filteredProducts = products; // Empezar con todos los productos para luego limitar
                    sectionTitle = "Bienvenido";
                    limitForDisplay = initialHomeAndBestsellersLimit; // Limitar a 8 para la visualización inicial
                    subcategoryPillsContainer.classList.add('hidden');
                } else if (activeCategory === 'Los más vendidos') {
                    // Para Los más vendidos, mostrar un número limitado de productos
                    // Aquí asumimos que los "más vendidos" son los primeros X productos en el array 'products'
                    // En una app real, esto se determinaría por un campo 'salesCount' o similar en Firestore
                    filteredProducts = products.slice(0, bestsellersLimit); 
                    sectionTitle = "Los Más Vendidos";
                    limitForDisplay = bestsellersLimit; // Limitar explícitamente a 4 para esta sección
                    subcategoryPillsContainer.classList.add('hidden');
                } else if (activeCategory === 'Todos') {
                    // Categoría 'Todos' seleccionada explícitamente (muestra TODOS los productos)
                    filteredProducts = products;
                    sectionTitle = "Todos Nuestros Productos";
                    subcategoryPillsContainer.classList.add('hidden');
                } else {
                    // Se selecciona una categoría de producto específica
                    filteredProducts = filteredProducts.filter(p => p.category === activeCategory);
                    sectionTitle = `Productos en ${activeCategory}`;
                    if (activeSubcategory !== 'Todos') {
                        filteredProducts = filteredProducts.filter(p => p.subcategory === activeSubcategory);
                        sectionTitle += ` > ${activeSubcategory}`;
                    }
                    displaySubcategories(); // Volver a renderizar subcategorías (se mostrarán si se selecciona la categoría)
                }
            }
            
            // 3. Aplicar ordenación
            let sortedProducts = [...filteredProducts]; // Crear una copia para ordenar
            switch (currentSortOrder) {
                case 'alpha_asc':
                    sortedProducts.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'alpha_desc':
                    sortedProducts.sort((a, b) => b.name.localeCompare(a.name));
                    break;
                case 'price_asc':
                    sortedProducts.sort((a, b) => (a.unitPrice || 0) - (b.unitPrice || 0));
                    break;
                case 'price_desc':
                    sortedProducts.sort((a, b) => (b.unitPrice || 0) - (a.unitPrice || 0));
                    break;
                case 'discount_desc':
                    // Calcular descuento: (precio unitario - precio mayorista) por unidad
                    sortedProducts.sort((a, b) => {
                        const discountA = (a.unitPrice || 0) - (a.wholesalePrice !== undefined && a.wholesalePrice !== null ? a.wholesalePrice : (a.unitPrice || 0));
                        const discountB = (b.unitPrice || 0) - (b.wholesalePrice !== undefined && b.wholesalePrice !== null ? b.wholesalePrice : (b.unitPrice || 0));
                        return discountB - discountA; // Orden descendente para el mejor descuento
                    });
                    break;
                case 'default':
                default:
                    // Sin ordenación específica, mantener el orden original o el orden predeterminado de los datos
                    break;
            }

            productSectionTitle.textContent = sectionTitle;

            // 4. Aplicar paginación/límite para la visualización
            let productsToDisplayFinal = [];
            if (limitForDisplay !== null) {
                // Para 'Inicio' y 'Los más vendidos', tenemos un límite inicial fijo
                productsToDisplayFinal = sortedProducts.slice(0, limitForDisplay);
                currentProductsDisplayedCount = productsToDisplayFinal.length;
            } else {
                // Para otras categorías, aplicar paginación incremental
                if (currentProductsDisplayedCount === 0) { // Primera carga para una categoría
                    currentProductsDisplayedCount = productsPerPage;
                }
                productsToDisplayFinal = sortedProducts.slice(0, currentProductsDisplayedCount);
            }

            displayProducts(productsToDisplayFinal); // Renderizar los productos

            // 5. Administrar el botón "VER MÁS PRODUCTOS" / "VER TODOS LOS PRODUCTOS"
            viewMoreProductsContainer.innerHTML = '';
            if (currentSearchQuery) {
                // No hay botón "ver más" al buscar
                viewMoreProductsContainer.classList.add('hidden');
            } else if (activeCategory === 'Inicio' || activeCategory === 'Los más vendidos') {
                if (sortedProducts.length > limitForDisplay) {
                    const button = document.createElement('button');
                    button.textContent = 'VER TODOS LOS PRODUCTOS';
                    button.className = 'mt-8 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-200 block mx-auto';
                    button.onclick = () => {
                        activeCategory = 'Todos'; // Cambiar la categoría activa a 'Todos'
                        isDesktopCategoriesExpanded = false; // Asegurarse de que la lista de categorías se colapse
                        displayCategories(); // Actualizar la barra de categorías
                        resetPagination(); // Reiniciar la paginación para 'Todos'
                        renderProductsBasedOnFiltersAndSearch(); // Volver a renderizar para mostrar todos los productos
                        window.scrollTo({ top: 0, behavior: 'smooth' }); // Desplazarse hacia arriba
                    };
                    viewMoreProductsContainer.classList.remove('hidden');
                    viewMoreProductsContainer.appendChild(button);
                } else {
                    viewMoreProductsContainer.classList.add('hidden');
                }
            } else if (sortedProducts.length > currentProductsDisplayedCount) {
                const button = document.createElement('button');
                button.textContent = 'VER MÁS PRODUCTOS';
                button.className = 'mt-8 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-200 block mx-auto';
                button.onclick = () => {
                    currentProductsDisplayedCount += productsPerPage;
                    renderProductsBasedOnFiltersAndSearch(); // Cargar más productos
                };
                viewMoreProductsContainer.classList.remove('hidden');
                viewMoreProductsContainer.appendChild(button);
            } else {
                viewMoreProductsContainer.classList.add('hidden');
            }

            updateSortDisplay(); // Asegurarse de que la visualización de ordenación sea correcta en cada renderizado
        }


        // --- Lógica de Cantidad y Precio ---
        window.updateQuantity = function(productId, change) {
            const qtyInput = document.getElementById(`qty-${productId}`);
            let currentQty = parseInt(qtyInput.value);
            currentQty = Math.max(0, currentQty + change);
            qtyInput.value = currentQty;
            updateDisplayedPrice(productId);
        };

        window.manualQuantityUpdate = function(productId, value) {
            const qtyInput = document.getElementById(`qty-${productId}`);
            let currentQty = parseInt(value);
            if (isNaN(currentQty) || currentQty < 0) {
                currentQty = 0;
            }
            qtyInput.value = currentQty;
            updateDisplayedPrice(productId);
        };

        function updateDisplayedPrice(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const qtyInput = document.getElementById(`qty-${productId}`);
            const currentQty = parseInt(qtyInput.value);

            const wholesalePriceElem = document.getElementById(`wholesale-price-display-${product.id}`);
            const wholesaleNoteElem = document.getElementById(`wholesale-note-${product.id}`);
            const unitPriceElem = document.getElementById(`unit-price-display-${product.id}`);
            const unitNoteElem = document.getElementById(`unit-note-${product.id}`);
            const priceMessageElem = document.getElementById(`price-message-${product.id}`);

            // Limpiar clases dinámicas anteriores para ambos elementos de precio y mensaje
            [wholesalePriceElem, unitPriceElem].forEach(el => {
                el.classList.remove('text-3xl', 'text-2xl', 'font-bold', 'text-green-600', 'text-blue-600', 'text-base', 'text-gray-500', 'line-through');
            });
            [wholesaleNoteElem, unitNoteElem].forEach(el => {
                el.classList.remove('text-green-600', 'text-blue-600');
                el.classList.add('text-gray-500'); // Asegurar el color gris predeterminado para las notas
            });
            priceMessageElem.classList.remove('text-green-700', 'text-blue-700', 'font-semibold');
            priceMessageElem.textContent = ''; // Limpiar mensaje anterior

            // Usar 0 si los precios no están definidos para evitar errores
            const currentWholesalePrice = product.wholesalePrice !== undefined ? product.wholesalePrice : 0;
            const currentUnitPrice = product.unitPrice !== undefined ? product.unitPrice : 0;
            const currentWholesaleQuantity = product.wholesaleQuantity !== undefined ? product.wholesaleQuantity : 0;

            if (currentQty >= currentWholesaleQuantity && currentWholesaleQuantity > 0) { // Asegurarse de que wholesaleQuantity sea positivo para aplicar el descuento
                // Si la cantidad alcanza el umbral de mayorista, el precio mayorista es prominente, el precio unitario se tacha
                wholesalePriceElem.classList.add('text-3xl', 'font-bold', 'text-green-600');
                wholesalePriceElem.textContent = `$${formatPrice(currentWholesalePrice)}`; // Update displayed price
                wholesaleNoteElem.classList.add('text-green-600');
                wholesaleNoteElem.classList.remove('text-gray-500');

                unitPriceElem.classList.add('text-base', 'text-gray-500', 'line-through');
                unitPriceElem.textContent = `$${formatPrice(currentUnitPrice)}`; // Update displayed price
                
                const savingPerUnit = currentUnitPrice - currentWholesalePrice;
                priceMessageElem.textContent = `¡Precio Mayorista Aplicado! Ahorras $${formatPrice(savingPerUnit)} por unidad.`;
                priceMessageElem.classList.add('text-green-700', 'font-semibold');

            } else {
                // Si la cantidad es inferior al umbral de mayorista, el precio unitario es prominente, el precio mayorista se tacha
                unitPriceElem.classList.add('text-3xl', 'font-bold', 'text-blue-600');
                unitPriceElem.textContent = `$${formatPrice(currentUnitPrice)}`; // Update displayed price
                unitNoteElem.classList.add('text-blue-600');
                unitNoteElem.classList.remove('text-gray-500');

                if (currentWholesaleQuantity > 0) { // Solo mostrar tachado y mensaje si existe precio mayorista
                    wholesalePriceElem.classList.add('text-base', 'text-gray-500', 'line-through');
                    wholesalePriceElem.textContent = `$${formatPrice(currentWholesalePrice)}`; // Update displayed price
                    const remainingToWholesale = currentWholesaleQuantity - currentQty;
                    priceMessageElem.textContent = `¡Ahorra! Añade ${remainingToWholesale} ${remainingToWholesale === 1 ? 'unidad' : 'unidades'} más para precio mayorista.`;
                    priceMessageElem.classList.add('text-blue-700', 'font-semibold');
                } else {
                    wholesalePriceElem.classList.remove('text-base', 'text-gray-500', 'line-through'); // Eliminar si no hay precio mayorista
                    wholesalePriceElem.textContent = `$${formatPrice(currentWholesalePrice)}`; // Asegurarse de que muestre el precio mayorista regular
                }
            }
        }


        // --- Gestión del Carrito ---
        window.addToCart = async function(productId) {
            const productToAdd = products.find(p => p.id === productId);
            const qtyInput = document.getElementById(`qty-${productId}`);
            const quantity = parseInt(qtyInput.value);

            if (!productToAdd || quantity <= 0) {
                showModal("Atención", "Por favor, selecciona una cantidad válida para añadir al carrito.", [{ text: "Entendido", action: "close" }]);
                return;
            }

            // Asegúrate de que el stock es un número válido. Si no, considera 0.
            const currentStock = typeof productToAdd.stock === 'number' ? productToAdd.stock : 0;

            if (quantity > currentStock) {
                showModal("Sin Stock", `Solo quedan ${currentStock} unidades de ${productToAdd.name}.`, [{ text: "Entendido", action: "close" }]);
                return;
            }

            // Determinar el precio basado en la cantidad
            let priceToUse;
            const wholesaleQuantity = typeof productToAdd.wholesaleQuantity === 'number' ? productToAdd.wholesaleQuantity : 0;
            const wholesalePrice = typeof productToAdd.wholesalePrice === 'number' ? productToAdd.wholesalePrice : 0;
            const unitPrice = typeof productToAdd.unitPrice === 'number' ? productToAdd.unitPrice : 0;


            if (quantity >= wholesaleQuantity && wholesaleQuantity > 0) {
                priceToUse = wholesalePrice;
            } else {
                priceToUse = unitPrice;
            }

            const itemInCart = cart.find(item => item.productId === productId);

            try {
                // Verifica que userId esté definido antes de intentar acceder a la colección
                if (!userId || userId === 'anonymous') {
                     showModal("Error de Autenticación", "No se pudo añadir al carrito. Por favor, recarga la página para asegurar tu sesión de usuario.", [{ text: "Cerrar", action: "close" }]);
                     return;
                }
                const cartCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/cart`);

                if (itemInCart) {
                    // Actualizar elemento existente en el carrito
                    const docRef = doc(cartCollectionRef, itemInCart.id);
                    await updateDoc(docRef, {
                        quantity: quantity, // Sobrescribir con la nueva cantidad del input
                        price: priceToUse // Actualizar precio en caso de que se haya cruzado el umbral
                    });
                    showNotification(`Se actualizó ${quantity} x ${productToAdd.name}`, 'info');
                } else {
                    // Añadir nuevo elemento al carrito
                    await addDoc(cartCollectionRef, {
                        productId: productId,
                        name: productToAdd.name,
                        price: priceToUse, // Almacenar el precio calculado (unitario o mayorista)
                        quantity: quantity,
                        imageUrl: productToAdd.imageUrl
                    });
                    showNotification(`¡AGREGADO! ${quantity} x ${productToAdd.name}`, 'success');
                }
                // Reiniciar el input de cantidad a 0 después de añadir al carrito
                qtyInput.value = 0;
                updateDisplayedPrice(productId); // Reiniciar la visualización del precio
            } catch (e) {
                console.error("Error adding/updating document: ", e);
                showModal("Error", `No se pudo añadir el producto al carrito. Error: ${e.message}.`, [{ text: "Cerrar", action: "close" }]);
            }
        };

        function updateCartCount() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCountElement.textContent = totalItems;
        }

        function displayCartContents() {
            currentStep = 0; // Indicar que estamos en la fase de visualización del carrito
            if (cart.length === 0) {
                showModal("Tu Carrito", '<p>Tu carrito está vacío.</p>', [{ text: "Cerrar", action: "close" }]);
                return;
            }

            let cartHtml = '<ul class="divide-y divide-gray-200">';
            let total = 0;

            cart.forEach(item => {
                const productDetails = products.find(p => p.id === item.productId); 
                const maxQuantity = productDetails && typeof productDetails.stock === 'number' ? productDetails.stock : (item.quantity > 0 ? item.quantity : 1000); 

                const itemTotal = (item.price || 0) * (item.quantity || 0); 
                total += itemTotal;
                cartHtml += `
                    <li class="py-3 flex items-center justify-between">
                        <div class="flex items-center">
                            <img src="${item.imageUrl}" alt="${item.name}" class="w-12 h-12 rounded-md mr-3 object-cover">
                            <div>
                                <p class="font-semibold">${item.name}</p>
                                <p class="text-sm text-gray-600">$${formatPrice(item.price || 0)} / unidad</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <div class="flex items-center border border-gray-300 rounded-md mr-3">
                                <button class="px-2 py-0.5 bg-gray-100 hover:bg-gray-200 rounded-l-md" onclick="updateCartItemQuantity('${item.id}', -1, ${maxQuantity})">-</button>
                                <input type="number" value="${item.quantity}" min="1" max="${maxQuantity}" class="w-12 text-center border-x border-gray-300 appearance-none [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none focus:outline-none" onchange="manualCartItemQuantityUpdate('${item.id}', this.value, ${maxQuantity})">
                                <button class="px-2 py-0.5 bg-gray-100 hover:bg-gray-200 rounded-r-md" onclick="updateCartItemQuantity('${item.id}', 1, ${maxQuantity})">+</button>
                            </div>
                            <span class="font-bold text-gray-800">$${formatPrice(itemTotal)}</span>
                            <button class="ml-3 text-red-500 hover:text-red-700" onclick="removeFromCart('${item.id}', '${item.name}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </li>
                `;
            });

            cartHtml += '</ul>';
            cartHtml += `<div class="mt-4 pt-4 border-t border-gray-200 flex justify-between items-center">
                            <span class="text-lg font-bold">Total:</span>
                            <span class="text-lg font-bold text-blue-600">$${formatPrice(total)}</span>
                          </div>`;

            showModal("Tu Carrito", cartHtml, [
                { text: "Seguir Comprando", action: "close" },
                { text: "Finalizar PEDIDO", action: "custom", className: 'bg-green-600', color: 'text-white', hover: 'hover:bg-green-700', callback: startCheckoutProcess }
            ]);
        }

        window.updateCartItemQuantity = async function(itemId, change, maxQuantity) {
            const itemToUpdate = cart.find(item => item.id === itemId);
            if (!itemToUpdate) return;

            let newQuantity = itemToUpdate.quantity + change;
            newQuantity = Math.max(1, newQuantity); // La cantidad mínima es 1
            newQuantity = Math.min(newQuantity, maxQuantity); // Limitar a maxQuantity (stock)

            if (newQuantity === itemToUpdate.quantity) {
                return;
            }

            try {
                if (!userId || userId === 'anonymous') {
                     showModal("Error de Autenticación", "No se pudo actualizar el carrito. Por favor, recarga la página para asegurar tu sesión de usuario.", [{ text: "Cerrar", action: "close" }]);
                     return;
                }
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/cart`, itemId);
                const productDetails = products.find(p => p.id === itemToUpdate.productId);

                let newPrice;
                if (productDetails) {
                    const wholesaleQuantity = typeof productDetails.wholesaleQuantity === 'number' ? productDetails.wholesaleQuantity : 0;
                    const wholesalePrice = typeof productDetails.wholesalePrice === 'number' ? productDetails.wholesalePrice : 0;
                    const unitPrice = typeof productDetails.unitPrice === 'number' ? productDetails.unitPrice : 0;

                    newPrice = (newQuantity >= wholesaleQuantity && wholesaleQuantity > 0) ? wholesalePrice : unitPrice;
                } else {
                    newPrice = itemToUpdate.price; // Fallback al precio actual si no se encuentran los detalles del producto
                }

                await updateDoc(docRef, { quantity: newQuantity, price: newPrice });
                showNotification(`Cantidad de ${itemToUpdate.name} actualizada a ${newQuantity}`, 'info');
            } catch (e) {
                console.error("Error updating cart item quantity: ", e);
                showModal("Error", `No se pudo actualizar la cantidad del producto. Error: ${e.message}`, [{ text: "Cerrar", action: "close" }]);
            }
        };

        window.manualCartItemQuantityUpdate = async function(itemId, value, maxQuantity) {
            const itemToUpdate = cart.find(item => item.id === itemId);
            if (!itemToUpdate) return;

            let newQuantity = parseInt(value);
            if (isNaN(newQuantity) || newQuantity < 1) {
                newQuantity = 1; // Por defecto a 1 si la entrada no es válida
            }
            newQuantity = Math.min(newQuantity, maxQuantity); // Limitar a maxQuantity (stock)

            // Actualizar el valor del input directamente para que refleje la cantidad clamped
            const inputElement = document.querySelector(`#customModal input[value="${itemToUpdate.quantity}"]`);
            if (inputElement) {
                inputElement.value = newQuantity;
            }


            if (newQuantity === itemToUpdate.quantity) {
                return;
            }

            try {
                if (!userId || userId === 'anonymous') {
                     showModal("Error de Autenticación", "No se pudo actualizar el carrito. Por favor, recarga la página para asegurar tu sesión de usuario.", [{ text: "Cerrar", action: "close" }]);
                     return;
                }
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/cart`, itemId);
                const productDetails = products.find(p => p.id === itemToUpdate.productId);

                let newPrice;
                if (productDetails) {
                    const wholesaleQuantity = typeof productDetails.wholesaleQuantity === 'number' ? productDetails.wholesaleQuantity : 0;
                    const wholesalePrice = typeof productDetails.wholesalePrice === 'number' ? productDetails.wholesalePrice : 0;
                    const unitPrice = typeof productDetails.unitPrice === 'number' ? productDetails.unitPrice : 0;
                    newPrice = (newQuantity >= wholesaleQuantity && wholesaleQuantity > 0) ? wholesalePrice : unitPrice;
                } else {
                    newPrice = itemToUpdate.price;
                }

                await updateDoc(docRef, { quantity: newQuantity, price: newPrice });
                showNotification(`Cantidad de ${itemToUpdate.name} actualizada a ${newQuantity}`, 'info');
            } catch (e) {
                console.error("Error updating cart item quantity: ", e);
                showModal("Error", `No se pudo actualizar la cantidad del producto. Error: ${e.message}`, [{ text: "Cerrar", action: "close" }]);
            }
        };


        window.removeFromCart = async function(itemId, itemName) {
            showModal("Confirmar Eliminación", `¿Estás seguro de que quieres eliminar "${itemName}" del carrito?`, [
                { text: "Cancelar", action: "close" },
                { text: "Eliminar", action: "confirm", callback: async () => {
                    try {
                        if (!userId || userId === 'anonymous') {
                            showModal("Error de Autenticación", "No se pudo eliminar del carrito. Por favor, recarga la página para asegurar tu sesión de usuario.", [{ text: "Cerrar", action: "close" }]);
                            return;
                        }
                        const docRef = doc(db, `artifacts/${appId}/users/${userId}/cart`, itemId);
                        await deleteDoc(docRef);
                        showNotification(`¡ELIMINADO! ${itemName}`, 'error');
                    } catch (e) {
                        console.error("Error removing document: ", e);
                        showModal("Error", `No se pudo eliminar "${itemName}".`, [{ text: "Cerrar", action: "close" }]);
                    }
                }}
            ]);
        };

        // --- Proceso de Pago en Múltiples Pasos ---
        function startCheckoutProcess() {
            checkoutData = {}; // Limpiar datos anteriores
            currentStep = 1;
            renderCheckoutStep();
        }

        function renderCheckoutStep() {
            let title = `Finalizar PEDIDO - Paso ${currentStep} de ${totalSteps}`;
            let bodyContent = '';
            let buttons = [];

            // Indicador de progreso
            bodyContent += `<p class="progress-indicator mb-4">Paso ${currentStep} de ${totalSteps}</p>`;

            switch (currentStep) {
                case 1:
                    modalTitle.textContent = title;
                    bodyContent += `
                        <p class="mb-4 font-semibold">Apellido y nombre:</p>
                        <label for="fullName" class="block text-sm font-medium text-gray-700 sr-only">Apellido y Nombre</label>
                        <input type="text" id="fullName" value="${checkoutData.fullName || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: Juan Pérez" required>
                    `;
                    buttons.push({ text: "Siguiente", action: "custom", className: 'bg-blue-600', color: 'text-white', hover: 'hover:bg-blue-700', callback: nextStep });
                    break;
                case 2:
                    modalTitle.textContent = title;
                    bodyContent += `
                        <p class="mb-4 font-semibold">Tipo de entrega:</p>
                        <div class="space-y-2">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="deliveryType" value="Retiro en Local" class="form-radio h-4 w-4 text-blue-600" ${checkoutData.deliveryType === 'Retiro en Local' ? 'checked' : ''}>
                                <span class="ml-2 text-gray-700">Retiro en Local</span>
                            </label>
                            <label class="inline-flex items-center ml-4 cursor-pointer">
                                <input type="radio" name="deliveryType" value="Delivery" class="form-radio h-4 w-4 text-blue-600" ${checkoutData.deliveryType === 'Delivery' ? 'checked' : ''}>
                                <span class="ml-2 text-gray-700">Delivery</span>
                            </label>
                        </div>
                    `;
                    // Añadir campos de dirección de entrega if la entrega fue seleccionada previamente como "Delivery"
                    if (checkoutData.deliveryType === 'Delivery') {
                         bodyContent += `
                            <div class="mt-4 p-4 border border-blue-200 bg-blue-50 rounded-md">
                                <p class="mb-2 font-semibold">Datos de envío para Delivery:</p>
                                <label for="deliveryStreet" class="block text-sm font-medium text-gray-700">Calle y Altura</label>
                                <input type="text" id="deliveryStreet" value="${checkoutData.deliveryStreet || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: Av. Rivadavia 1234" required>

                                <label for="deliveryLocation" class="block text-sm font-medium text-gray-700 mt-3">Localidad</label>
                                <input type="text" id="deliveryLocation" value="${checkoutData.deliveryLocation || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: CABA" required>

                                <label for="deliveryZipCode" class="block text-sm font-medium text-gray-700 mt-3">Código Postal</label>
                                <input type="text" id="deliveryZipCode" value="${checkoutData.deliveryZipCode || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: 1406" required>
                            </div>
                        `;
                    }
                    buttons.push({ text: "Anterior", action: "custom", className: 'bg-gray-200', color: 'text-gray-800', hover: 'hover:bg-gray-300', callback: prevStep });
                    buttons.push({ text: "Siguiente", action: "custom", className: 'bg-blue-600', color: 'text-white', hover: 'hover:bg-blue-700', callback: nextStep });
                    break;
                case 3:
                    modalTitle.textContent = title;
                    bodyContent += `
                        <p class="mb-4 font-semibold">Método de pago:</p>
                        <div class="space-y-2">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="paymentMethod" value="Efectivo" class="form-radio h-4 w-4 text-blue-600" ${checkoutData.paymentMethod === 'Efectivo' ? 'checked' : ''}>
                                <span class="ml-2 text-gray-700">Efectivo</span>
                            </label>
                            <label class="inline-flex items-center ml-4 cursor-pointer">
                                <input type="radio" name="paymentMethod" value="Transferencia" class="form-radio h-4 w-4 text-blue-600" ${checkoutData.paymentMethod === 'Transferencia' ? 'checked' : ''}>
                                <span class="ml-2 text-gray-700">Transferencia</span>
                            </label>
                            <label class="inline-flex items-center ml-4 cursor-pointer">
                                <input type="radio" name="paymentMethod" value="Debito/Credito" class="form-radio h-4 w-4 text-blue-600" ${checkoutData.paymentMethod === 'Debito/Credito' ? 'checked' : ''}>
                                <span class="ml-2 text-gray-700">Débito/Crédito</span>
                            </label>
                        </div>
                    `;
                    buttons.push({ text: "Anterior", action: "custom", className: 'bg-gray-200', color: 'text-gray-800', hover: 'hover:bg-gray-300', callback: prevStep });
                    buttons.push({ text: "Siguiente", action: "custom", className: 'bg-blue-600', color: 'text-white', hover: 'hover:bg-blue-700', callback: nextStep });
                    break;
                case 4:
                    modalTitle.textContent = title;
                    bodyContent += `
                        <p class="mb-4 font-semibold">Observaciones:</p>
                        <textarea id="observations" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm h-24" placeholder="Ej: Entregar por la mañana, llamar al llegar, etc.">${checkoutData.observations || ''}</textarea>
                    `;
                    buttons.push({ text: "Anterior", action: "custom", className: 'bg-gray-200', color: 'text-gray-800', hover: 'hover:bg-gray-300', callback: prevStep });
                    buttons.push({ text: "Enviar Pedido", action: "custom", className: 'bg-green-600', color: 'text-white', hover: 'hover:bg-green-700', callback: sendOrderToWhatsApp });
                    break;
            }

            modalBody.innerHTML = bodyContent;
            modalFooter.innerHTML = ''; // Limpiar botones existentes
            buttons.forEach(btn => {
                const buttonElement = document.createElement('button');
                buttonElement.textContent = btn.text;
                buttonElement.className = 'px-4 py-2 rounded-md transition-colors duration-200 ' + btn.className;
                buttonElement.onclick = btn.callback;
                modalFooter.appendChild(buttonElement);
            });

            customModal.classList.remove('hidden');

            // Añadir event listeners para los botones de radio para actualizar los campos de entrega dinámicamente
            if (currentStep === 2) {
                const deliveryRadios = document.querySelectorAll('input[name="deliveryType"]');
                deliveryRadios.forEach(radio => {
                    radio.addEventListener('change', (event) => {
                        checkoutData.deliveryType = event.target.value;
                        renderCheckoutStep(); // Volver a renderizar para mostrar/ocultar los campos de dirección
                    });
                });
            }
        }

        function nextStep() {
            if (currentStep === 1) {
                const fullName = document.getElementById('fullName').value.trim();
                if (!fullName) {
                    showModal("Error", "Por favor, ingresa tu Apellido y Nombre.", [{ text: "Entendido", action: "close" }]);
                    return;
                }
                checkoutData.fullName = fullName;
            } else if (currentStep === 2) {
                const selectedDeliveryType = document.querySelector('input[name="deliveryType"]:checked');
                if (!selectedDeliveryType) {
                    showModal("Error", "Por favor, selecciona un tipo de entrega.", [{ text: "Entendido", action: "close" }]);
                    return;
                }
                checkoutData.deliveryType = selectedDeliveryType.value;

                if (checkoutData.deliveryType === 'Delivery') {
                    const street = document.getElementById('deliveryStreet').value.trim();
                    const location = document.getElementById('deliveryLocation').value.trim();
                    const zipCode = document.getElementById('deliveryZipCode').value.trim();
                    if (!street || !location || !zipCode) {
                        showModal("Error", "Por favor, completa todos los datos de envío para Delivery.", [{ text: "Entendido", action: "close" }]);
                        return;
                    }
                    checkoutData.deliveryStreet = street;
                    checkoutData.deliveryLocation = location;
                    checkoutData.deliveryZipCode = zipCode;
                } else {
                    // Limpiar datos de entrega si se cambia de Delivery a Retiro
                    delete checkoutData.deliveryStreet;
                    delete checkoutData.deliveryLocation;
                    delete checkoutData.deliveryZipCode;
                }
            } else if (currentStep === 3) {
                const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
                if (!selectedPaymentMethod) {
                    showModal("Error", "Por favor, selecciona un método de pago.", [{ text: "Entendido", action: "close" }]);
                    return;
                }
                checkoutData.paymentMethod = selectedPaymentMethod.value;
            } else if (currentStep === 4) {
                checkoutData.observations = document.getElementById('observations').value.trim();
                // Este es el último paso, así que enviar el pedido
                sendOrderToWhatsApp();
                return; // Evitar incrementar currentStep más allá
            }

            currentStep++;
            renderCheckoutStep();
        }

        function prevStep() {
            currentStep--;
            renderCheckoutStep();
        }

        async function sendOrderToWhatsApp() {
            // Validar los datos finales (debería haberse hecho ya por nextStep, pero una verificación final)
            if (!checkoutData.fullName || !checkoutData.deliveryType || !checkoutData.paymentMethod || cart.length === 0) {
                 showModal("Error", "Faltan datos para completar tu pedido o el carrito está vacío.", [{ text: "Volver", action: "custom", className: 'bg-blue-600', color: 'text-white', hover: 'hover:bg-blue-700', callback: renderCheckoutStep }]);
                 return;
            }

            let orderSummary = `¡Hola! Mi nombre es *${checkoutData.fullName}*.\n\n`;
            orderSummary += `Quiero hacer el siguiente pedido: 👇\n\n`;

            orderSummary += `*📦 Productos:*\n`;
            let totalOrderPrice = 0;
            cart.forEach((item) => {
                const itemTotal = (item.price || 0) * (item.quantity || 0); 
                totalOrderPrice += itemTotal;
                orderSummary += `* ${item.name} (${item.quantity}x) - $${formatPrice(item.price || 0)} = *$${formatPrice(itemTotal)}*\n`;
            });

            orderSummary += `\n*💲 Total del Pedido: $${formatPrice(totalOrderPrice)}*\n\n`;

            orderSummary += `*🚚 Método de Entrega:* _${checkoutData.deliveryType}_\n`;
            if (checkoutData.deliveryType === 'Delivery') {
                orderSummary += `_Dirección: ${checkoutData.deliveryStreet}, ${checkoutData.deliveryLocation}, C.P. ${checkoutData.deliveryZipCode}_\n`;
            }
            orderSummary += `*💳 Método de Pago:* _${checkoutData.paymentMethod}_\n\n`;

            if (checkoutData.observations) {
                orderSummary += `*📝 Observaciones:*\n_${checkoutData.observations}_\n\n`;
            }

            orderSummary += `*¡Muchas gracias por tu compra!* 😊`;

            // Número de WhatsApp
            const whatsappNumber = '5491136013353';
            const whatsappUrl = `whatsapp://send?phone=${whatsappNumber}&text=${encodeURIComponent(orderSummary)}`;

            try {
                // Limpiar el carrito en Firestore después de generar el resumen del pedido
                if (!userId || userId === 'anonymous') {
                    showModal("Error de Autenticación", "No se pudo limpiar el carrito. Por favor, recarga la página para asegurar tu sesión de usuario.", [{ text: "Cerrar", action: "close" }]);
                    return;
                }
                const cartRef = collection(db, `artifacts/${appId}/users/${userId}/cart`);
                const q = query(cartRef);
                const querySnapshot = await getDocs(q);
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);

                showNotification("¡PEDIDO ENVIADO!", 'success');
                customModal.classList.add('hidden'); // Cerrar modal
                currentStep = 0; // Reiniciar paso
                window.open(whatsappUrl, '_blank'); // Abrir WhatsApp
            } catch (e) {
                console.error("Error al Enviar Pedido", e);
                showModal("Error al Enviar Pedido", `Hubo un problema al procesar tu pedido o al abrir WhatsApp. Error: ${e.message}`, [{ text: "Cerrar", action: "close" }]);
            }
        }

        // --- Generación de Productos Aleatorios y Carga a Firestore ---
        // Listas de datos para la generación de productos
        const productCategories = [
            'Bebidas', 'Comestibles', 'Lácteos y Frescos', 'Limpieza',
            'Cuidado Personal', 'Panadería y Pastelería', 'Snacks', 'Aderezos y Salsas',
            'Frutas y Verduras', 'Bebés y Niños'
        ];

        const productSubcategories = {
            'Bebidas': ['Gaseosas', 'Jugos', 'Aguas', 'Vinos', 'Cervezas', 'Infusiones'],
            'Comestibles': ['Arroz y Legumbres', 'Pastas', 'Harinas y Premezclas', 'Enlatados', 'Condimentos', 'Aceites'],
            'Lácteos y Frescos': ['Leches', 'Quesos', 'Yogures y Postres', 'Cremas y Untables'],
            'Limpieza': ['Lavandería', 'Cocina', 'Desinfectantes', 'Papel y Servilletas', 'Baño'],
            'Cuidado Personal': ['Cuidado del Cabello', 'Higiene Bucal', 'Higiene Corporal', 'Afeitado'],
            'Panadería y Pastelería': ['Panes', 'Galletas', 'Bizcochos'],
            'Snacks': ['Papas Fritas', 'Chocolates', 'Dulces', 'Frutos Secos'],
            'Aderezos y Salsas': ['Salsas Frías', 'Salsas Calientes', 'Especias'],
            'Frutas y Verduras': ['Frutas', 'Verduras'],
            'Bebés y Niños': ['Pañales', 'Cuidado del Bebé', 'Alimentos para Bebés']
        };

        const productBaseNames = [
            'Arroz', 'Fideos', 'Aceite', 'Azúcar', 'Sal', 'Leche', 'Yogur', 'Queso', 'Manteca',
            'Pan', 'Galletas', 'Café', 'Té', 'Yerba Mate', 'Gaseosa', 'Jugo', 'Agua Mineral',
            'Vino', 'Cerveza', 'Detergente', 'Lavandina', 'Jabón', 'Champú', 'Acondicionador',
            'Pasta Dental', 'Cereal', 'Atún', 'Tomate', 'Mayonesa', 'Ketchup', 'Mostaza',
            'Mermelada', 'Chocolate', 'Caramelos', 'Papas Fritas', 'Cebolla', 'Papa', 'Manzana',
            'Naranja', 'Banana', 'Pañales', 'Toallitas Húmedas', 'Alcohol en Gel', 'Esponja', 'Servilletas'
        ];

        const genericDescriptions = [
            "Un producto esencial para tu hogar, de la más alta calidad y frescura garantizada. Ideal para el consumo diario de toda la familia.",
            "Disfruta de este artículo premium, perfecto para tus comidas o para un momento de relax. Sabor y calidad que se sienten en cada bocado/sorbo.",
            "Innovación y practicidad en un solo producto. Diseñado para simplificar tu rutina y ofrecer resultados excelentes en cada uso.",
            "El acompañante ideal para tus recetas favoritas. Su textura y sabor únicos lo hacen indispensable en tu cocina. ¡Descúbrelo!",
            "Cuidado y bienestar al alcance de tu mano. Este producto está formulado con ingredientes seleccionados para tu piel y cuerpo."
        ]; 

        const productImages = [
            'https://images.unsplash.com/photo-1542838183-8a9d18728d3a?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', // 
            'https://images.unsplash.com/photo-1599026040713-39828d13e9a5?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', // 
            'https://images.unsplash.com/photo-1547906939-bfdc0155b112?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', // 
            'https://images.unsplash.com/photo-1625937172089-61ac9d81d6d6?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', // 
            'https://images.unsplash.com/photo-1579621970795-87facc2f976d?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', // 
            'https://images.unsplash.com/photo-1582299616039-444a9bf48083?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', // 
            'https://images.unsplash.com/photo-1622253018484-904d9c4c7c8c?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', // 
            'https://images.unsplash.com/photo-1594211116223-9523275c92c9?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', // 
            'https://images.unsplash.com/photo-1594282463718-e3c7ba5d0f66?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', // 
            'https://images.unsplash.com/photo-1586788224331-ad935c851174?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', // 
        ];


        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // --- Función para generar los 100 productos con todos los campos solicitados ---
        function generateRandomProductsData(numProducts = 100) {
            const generatedProducts = [];
            for (let i = 0; i < numProducts; i++) {
                const productId = `prod${Date.now()}-${i}-${getRandomInt(1000, 9999)}`;
                
                // Generar Categoría y Subcategoría
                const randomCategory = productCategories[getRandomInt(0, productCategories.length - 1)];
                const availableSubcategories = productSubcategories[randomCategory];
                const randomSubcategory = availableSubcategories[getRandomInt(0, availableSubcategories.length - 1)];
                
                // Generar Nombre del Producto
                const randomBaseName = productBaseNames[getRandomInt(0, productBaseNames.length - 1)];
                const productName = `${randomBaseName} ${i+1}`; // Nombre simple y único

                // Generar Precios y Cantidades (enteros para simplificar)
                const unitPrice = getRandomInt(1, 20) * 1000; // PRECIO EN MILES, SIN CENTAVOS
                const wholesalePrice = Math.floor(unitPrice * (0.6 + Math.random() * 0.2)); // 60-80% del precio unitario, SIN CENTAVOS
                const wholesaleQuantity = getRandomInt(3, 15); // Cantidad para precio mayorista
                const stock = getRandomInt(50, 500); // Stock aleatorio

                // Generar URL de Imagen y Descripción
                const imageUrl = productImages[getRandomInt(0, productImages.length - 1)]; 
                const description = genericDescriptions[getRandomInt(0, genericDescriptions.length - 1)]; 

                const product = {
                    id: productId,
                    name: productName,
                    category: randomCategory,
                    subcategory: randomSubcategory,
                    imageUrl: imageUrl,
                    unitPrice: unitPrice,
                    wholesalePrice: wholesalePrice,
                    wholesaleQuantity: wholesaleQuantity,
                    stock: stock,
                    description: description,
                };
                generatedProducts.push(product);
            }
            return generatedProducts;
        }

        async function uploadProductsToFirestore() {
            if (!db || !userId) {
                showModal("Error", "Firebase no está inicializado o el usuario no está autenticado.", [{ text: "Cerrar", action: "close" }]);
                return;
            }

            const productsCollectionRef = collection(db, `artifacts/${appId}/public/data/products`);
            const existingProductsSnapshot = await getDocs(productsCollectionRef);

            if (!existingProductsSnapshot.empty) {
                showModal("Productos Existentes", "Ya hay productos cargados en Firestore. ¿Deseas reemplazar **todos** los productos existentes con 100 nuevos productos aleatorios? Esta acción eliminará los productos actuales.", [
                    { text: "Cancelar", action: "close" },
                    { text: "Reemplazar y Cargar Nuevos", action: "confirm", callback: async () => {
                        showModal("Eliminando Productos", "Eliminando productos existentes. Por favor, espera...", []);
                        const deletePromises = existingProductsSnapshot.docs.map(doc => deleteDoc(doc.ref));
                        await Promise.all(deletePromises);
                        showNotification("Productos anteriores eliminados. Cargando nuevos...", 'info');
                        await performProductUpload();
                    }}
                ]);
            } else {
                await performProductUpload();
            }
        }

        async function performProductUpload() {
            showModal("Cargando Productos", "Generando y cargando 100 productos de ejemplo a Firestore. Esto puede tardar un momento...", []);

            try {
                const newProducts = generateRandomProductsData(100); 
                const productsCollectionRef = collection(db, `artifacts/${appId}/public/data/products`); 
                let uploadedCount = 0;

                for (const product of newProducts) {
                    await setDoc(doc(productsCollectionRef, product.id), product); 
                    uploadedCount++;
                    modalBody.innerHTML = `Generando y cargando 100 productos de ejemplo a Firestore...<br/><br/>**Cargados: ${uploadedCount} de ${newProducts.length}**`;
                }

                showModal("Carga Completa", `Se cargaron ${uploadedCount} productos a Firestore. La página se actualizará automáticamente.`, [{ text: "Genial!", action: "close" }]);
                showNotification("¡Productos cargados exitosamente! Refrescando...", 'success');
            } catch (error) {
                console.error("Error uploading products to Firestore:", error);
                showModal("Error de Carga", `Hubo un problema al cargar los productos a Firestore. Consulta la consola del navegador para más detalles. Error: ${error.message}`, [{ text: "Cerrar", action: "close" }]);
            }
        }

        // --- Event Listeners ---
        document.getElementById('hamburger-menu').addEventListener('click', () => {
            document.getElementById('sidebar').classList.add('open');
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('hamburger-menu').classList.add('open');
        });

        document.getElementById('close-sidebar').addEventListener('click', () => {
            closeSidebar();
        });

        document.getElementById('overlay').addEventListener('click', () => {
            closeSidebar();
        });

        document.getElementById('cart-button').addEventListener('click', () => {
            displayCartContents(); // Esto mostrará el modal del contenido del carrito
        });

        document.getElementById('floating-cart-button').addEventListener('click', () => {
            displayCartContents(); // Esto mostrará el modal del contenido del carrito
        });

        // Alternar barra de búsqueda y listener de entrada
        searchToggleButton.addEventListener('click', () => {
            searchInput.classList.toggle('opacity-0');
            searchInput.classList.toggle('pointer-events-none');
            // Si la barra de búsqueda se vuelve visible, enfocarla
            if (!searchInput.classList.contains('opacity-0')) {
                searchInput.focus();
            }
        });

        searchInput.addEventListener('input', (event) => {
            currentSearchQuery = event.target.value.trim();
            activeCategory = 'Todos'; // Reiniciar la categoría activa a 'Todos' (mostrar todo) al buscar
            activeSubcategory = 'Todos'; // Las subcategorías se ocultarán
            isDesktopCategoriesExpanded = false; // Colapsar categorías de escritorio al buscar
            displayCategories();
            displaySubcategories();
            resetPagination(); // Reiniciar paginación al buscar
            renderProductsBasedOnFiltersAndSearch();
        });

        // Alternar menú desplegable de filtro de ordenación
        sortFilterToggle.addEventListener('click', (event) => {
            event.stopPropagation(); // Evitar que el clic se propague al documento y se cierre inmediatamente
            sortFilterDropdown.classList.toggle('hidden');
        });

        // Cerrar menú desplegable de filtro de ordenación al hacer clic fuera
        document.addEventListener('click', (event) => {
            if (!sortFilterDropdown.contains(event.target) && !sortFilterToggle.contains(event.target)) {
                sortFilterDropdown.classList.add('hidden');
            }
        });

        // Asegurarse de que el input de búsqueda sea visible en pantallas grandes por defecto
        function checkScreenSizeForSearchInput() {
            if (window.innerWidth >= 1024) { // Equivalente al breakpoint lg de Tailwind
                searchInput.classList.remove('opacity-0', 'pointer-events-none');
                searchInput.classList.add('lg:static', 'lg:translate-y-0', 'lg:w-auto', 'lg:opacity-100', 'lg:pointer-events-auto', 'lg:ml-4');
            } else {
                searchInput.classList.add('opacity-0', 'pointer-events-none');
                searchInput.classList.remove('lg:static', 'lg:translate-y-0', 'lg:w-auto', 'lg:opacity-100', 'lg:pointer-events-auto', 'lg:ml-4');
            }
        }

        // Llamar al cargar y al redimensionar
        checkScreenSizeForSearchInput();
        window.addEventListener('resize', checkScreenSizeForSearchInput);

        // Event listener para el botón de carga de productos
        uploadProductsBtn.addEventListener('click', uploadProductsToFirestore);
    </script>
</body>
</html>