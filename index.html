<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tu Supermercado Mayorista</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f8f8;
            color: #333;
        }
        /* Custom styles for hamburger menu icon */
        .hamburger {
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            width: 24px;
            height: 24px;
            padding: 0;
            background: transparent;
            border: none;
            z-index: 50;
        }
        .hamburger span {
            display: block;
            width: 100%;
            height: 3px;
            background-color: #333;
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        .hamburger.open span:nth-child(1) {
            transform: translateY(10px) rotate(45deg);
        }
        .hamburger.open span:nth-child(2) {
            opacity: 0;
        }
        .hamburger.open span:nth-child(3) {
            transform: translateY(-10px) rotate(-45deg);
        }

        /* Sidebar styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: -280px; /* Hidden by default */
            width: 280px;
            height: 100%;
            background-color: #fff;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
            transition: left 0.3s ease-in-out;
            z-index: 40;
            padding: 20px;
            overflow-y: auto;
        }
        .sidebar.open {
            left: 0; /* Visible when open */
        }
        .sidebar .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #555;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 30;
            display: none;
        }

        /* Hero section specific styles */
        .hero-banner {
            background: url('https://static.cotodigital3.com.ar/sitios/cdigi/static/content/images/cdigi/ofertas/cartridge/nuevahome/2025-01/images/cepas060625.jpg') no-repeat center center/cover;
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }

        /* Category Card (Mobile view, Pill style) */
        .category-card {
            background-color: #f0f4f8; /* Very light blue-gray */
            color: #4a5568; /* Darker gray */
            padding: 0.5rem 1rem; /* Reduced padding */
            border-radius: 9999px; /* Pill shape */
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; /* Simpler transition */
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #cbd5e0; /* Light border */
        }
        .category-card:hover {
            background-color: #e2e8f0; /* Slightly darker on hover */
        }
        .category-card.active {
            background-color: #3b82f6; /* Blue 600 */
            color: white;
            border-color: #3b82f6; /* Matching border */
        }

        /* Main Category Link (Desktop view, Text link style in new section) */
        .main-category-link {
            padding: 0.5rem 0.75rem;
            color: #333;
            font-weight: 500;
            text-decoration: none;
            position: relative;
            transition: color 0.3s ease;
            white-space: nowrap; /* Prevent wrapping */
        }
        .main-category-link:hover {
            color: #3b82f6; /* Blue 600 */
        }
        .main-category-link.active {
            color: #1d4ed8; /* Darker blue */
            font-weight: 600;
        }
        .main-category-link.active::after {
            content: '';
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: -5px; /* Adjust as needed */
            width: calc(100% - 1.5rem); /* Adjust based on padding */
            height: 3px;
            background-color: #1d4ed8; /* Darker blue */
            border-radius: 2px;
        }
        /* Separator for desktop main category links */
        .main-category-link + .nav-separator {
            color: #ccc; /* Light gray */
            padding: 0 0.5rem;
            font-size: 1.25rem;
            align-self: center;
        }

        /* Subcategory pills (used in product view) */
        .subcategory-pill {
            background-color: #f0f4f8; /* Light gray-blue */
            color: #4a5568; /* Darker gray */
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 1px solid #cbd5e0; /* border-gray-300 */
            white-space: nowrap; /* Prevent wrapping */
        }
        .subcategory-pill:hover {
            background-color: #e2e8f0; /* Slightly darker on hover */
            transform: translateY(-1px);
        }
        .subcategory-pill.active {
            background-color: #3b82f6; /* Blue 600 */
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3);
        }

        /* General styles for product view */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        /* Desktop: Force 4 columns on large screens */
        @media (min-width: 1024px) { /* Equivalent to Tailwind's lg: breakpoint */
            .product-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Responsive adjustments for categories section on smaller screens */
        @media (max-width: 767px) {
            .desktop-only {
                display: none;
            }
            .mobile-only {
                display: block;
            }
        }
        @media (min-width: 768px) {
            .mobile-only {
                display: none;
            }
            .desktop-only {
                display: block;
            }
        }

        /* Custom styles for floating cart button */
        .floating-cart-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #3b82f6; /* Blue 600 */
            color: white;
            border-radius: 9999px; /* Fully rounded */
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 9999; /* Increased z-index to prevent collision */
            transition: all 0.3s ease;
        }
        .floating-cart-button:hover {
            background-color: #1d4ed8; /* Darker blue */
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0,0,0,0.15);
        }

        /* Notification message styles */
        #notification-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100%); /* Start off-screen */
            z-index: 100;
            padding: 1rem 2rem;
            border-radius: 9999px; /* Pill shape */
            font-weight: 600;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        #notification-message.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Styles for the progress bar (simple text based) */
        .progress-indicator {
            font-size: 0.9rem;
            color: #6b7280; /* gray-500 */
            margin-top: 5px;
            text-align: center;
        }

        /* Styles for individual product cards (consistent height) */
        .product-card-item {
            min-height: 480px; /* Increased min-height to accommodate more content and ensure vertical alignment */
        }

        /* Styles for the custom sort dropdown */
        /* Removed previous custom CSS for .sort-dropdown-container to rely on Tailwind's absolute positioning */

        #sort-filter-toggle {
            cursor: pointer;
            outline: none;
            width: 100%; /* Full width on mobile */
        }
        /* No specific desktop width for toggle button - auto width from flex container */

        #sort-filter-dropdown {
            position: absolute;
            right: 0; /* Align to the right of its parent container */
            top: 100%; /* Position below the toggle button */
            margin-top: 0.5rem; /* Space between button and dropdown */
            width: 200px; /* Fixed width for dropdown */
            background-color: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 30; /* Ensure it's above other content */
        }
        /* Style for filter radio button labels */
        #sort-filter-dropdown label {
            padding: 0.5rem 1rem;
            display: flex; /* Use flex for alignment of radio and text */
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        #sort-filter-dropdown label:hover {
            background-color: #f0f4f8; /* Light hover background */
        }
        #sort-filter-dropdown input[type="radio"] {
            margin-right: 0.5rem;
            /* Optional: custom radio button styling */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Notification Message -->
    <div id="notification-message" class="hidden"></div>

    <!-- Top Bar (Header) -->
    <header class="bg-white shadow-md p-4 flex justify-between items-center relative z-20">
        <button class="hamburger" id="hamburger-menu">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <h1 class="text-xl font-bold">Tu Supermercado Mayorista</h1>
        <div class="flex items-center space-x-4">
            <!-- Search input and button -->
            <div class="relative flex items-center">
                <button class="text-gray-600 hover:text-gray-900 focus:outline-none" id="search-toggle-button">
                    <i class="fas fa-search"></i>
                </button>
                <input type="search" id="search-input" placeholder="Buscar productos..."
                       class="absolute right-0 top-1/2 -translate-y-1/2 w-48 p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500
                              opacity-0 pointer-events-none transition-all duration-300 ease-in-out
                              lg:static lg:translate-y-0 lg:w-auto lg:opacity-100 lg:pointer-events-auto lg:ml-4">
            </div>
            <!-- Cart button -->
            <button class="text-gray-600 hover:text-gray-900 focus:outline-none" id="cart-button">
                <i class="fas fa-shopping-cart"></i>
                <span id="cart-count" class="bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center -ml-2 -mt-2 absolute top-4 right-4 sm:static">0</span>
            </button>
        </div>
    </header>

    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <button class="close-btn" id="close-sidebar">&times;</button>
        <ul class="space-y-4 pt-10">
            <li><a href="#" class="block text-lg font-semibold text-gray-700 hover:text-blue-600" onclick="filterProductsByCategory('Inicio'); closeSidebar();">Inicio</a></li>
            <li><a href="#" class="block text-lg font-semibold text-gray-700 hover:text-blue-600" onclick="filterProductsByCategory('Los más vendidos'); closeSidebar();">Los más vendidos</a></li>
            <li><a href="#" class="block text-lg font-semibold text-gray-700 hover:text-blue-600">Ofertas</a></li>
            <li class="border-t border-gray-200 pt-4 mt-4">
                <h4 class="text-md font-semibold mb-2 text-gray-600">Categorías de Productos</h4>
                <div id="sidebar-categories-list" class="space-y-2">
                    <!-- Dynamic categories will be loaded here -->
                </div>
            </li>
            <li><a href="#" class="block text-lg font-semibold text-gray-700 hover:text-blue-600">Contacto</a></li>
            <li><a href="#" class="block text-lg font-semibold text-gray-700 hover:text-blue-600">Mi Cuenta</a></li>
        </ul>
    </nav>

    <!-- Overlay for sidebar -->
    <div class="overlay" id="overlay"></div>

    <main class="flex-grow">
        <!-- Hero Banner Section -->
        <section class="hero-banner h-48 sm:h-64 md:h-80 flex items-center justify-center text-center p-4">
            <div class="container mx-auto">
                <!-- <h2 class="text-3xl sm:text-4xl md:text-5xl font-bold mb-2">Grandes Ahorros, Compras al Por Mayor</h2>
                <p class="text-lg sm:text-xl md:text-2xl">Todo lo que necesitas, a precios mayoristas.</p> -->
            </div>
        </section>

        <!-- Categories Section (Mobile - Pills) -->
        <section class="mobile-only p-4">
            <h3 class="text-xl font-semibold mb-4 text-center">Explora Nuestras Categorías</h3>
            <div id="mobile-categories-container" class="flex flex-wrap justify-center gap-2">
                <!-- Categories will be dynamically loaded here for mobile -->
            </div>
        </section>

        <!-- Categories Section (Desktop - Links) -->
        <section class="desktop-only p-4 bg-white shadow-sm">
            <div class="container mx-auto flex justify-center items-center overflow-x-auto whitespace-nowrap py-2 scrollbar-hide">
                <nav class="flex space-x-1">
                    <!-- Main categories will be dynamically loaded here for desktop -->
                    <div id="desktop-main-categories-container" class="flex"></div>
                </nav>
            </div>
        </section>

        <!-- Product Listing Section -->
        <section class="p-4 sm:p-6 lg:p-8 relative"> <!-- Added relative to this section for absolute positioning of filter -->
            <div class="container mx-auto">
                <h3 id="product-section-title" class="text-2xl font-bold mb-6 text-center">Nuestros Productos</h3>

                <!-- Subcategory pills for product filtering -->
                <div id="subcategory-pills-container" class="flex flex-wrap justify-center gap-2 mb-6 hidden">
                    <!-- Subcategory pills will be dynamically loaded here -->
                </div>

                <!-- Filter/Sort Dropdown - Positioned absolutely relative to the section -->
                <div class="sort-dropdown-container absolute top-4 right-4 z-20">
                    <button id="sort-filter-toggle" class="px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm flex items-center justify-between">
                        <span>Ordenar por: <span id="current-sort-display" class="font-normal text-gray-600">Defecto</span></span>
                        <i class="fas fa-chevron-down ml-2 text-gray-500"></i>
                    </button>

                    <div id="sort-filter-dropdown" class="hidden">
                        <div class="p-2">
                            <label class="block cursor-pointer">
                                <input type="radio" name="sortOrder" value="default" class="mr-2" onchange="setSortOrder(this.value)">
                                <span>Por defecto</span>
                            </label>
                            <label class="block cursor-pointer">
                                <input type="radio" name="sortOrder" value="alpha_asc" class="mr-2" onchange="setSortOrder(this.value)">
                                <span>Alfabético (A-Z)</span>
                            </label>
                            <label class="block cursor-pointer">
                                <input type="radio" name="sortOrder" value="alpha_desc" class="mr-2" onchange="setSortOrder(this.value)">
                                <span>Alfabético (Z-A)</span>
                            </label>
                            <label class="block cursor-pointer">
                                <input type="radio" name="sortOrder" value="price_asc" class="mr-2" onchange="setSortOrder(this.value)">
                                <span>Precio (Menor a Mayor)</span>
                            </label>
                            <label class="block cursor-pointer">
                                <input type="radio" name="sortOrder" value="price_desc" class="mr-2" onchange="setSortOrder(this.value)">
                                <span>Precio (Mayor a Menor)</span>
                            </label>
                            <label class="block cursor-pointer">
                                <input type="radio" name="sortOrder" value="discount_desc" class="mr-2" onchange="setSortOrder(this.value)">
                                <span>Mejor Descuento</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- This will display the filtered product grid -->
                <!-- Added a margin-top to prevent overlap with the absolutely positioned filter -->
                <div id="product-display-container" class="product-grid mt-16 md:mt-12">
                    <!-- Products will be dynamically loaded here -->
                </div>
                <p id="no-products-message" class="text-center text-gray-500 hidden mt-8">No se encontraron productos que coincidan con tu búsqueda.</p>
                <div id="view-more-products-container" class="mt-8 text-center">
                    <!-- "VER TODOS LOS PRODUCTOS" or "VER MÁS PRODUCTOS" button will be added here conditionally -->
                </div>
            </div>
        </section>
    </main>

    <!-- Floating Cart Button -->
    <button id="floating-cart-button" class="floating-cart-button">
        <i class="fas fa-shopping-cart"></i>
    </button>

    <!-- Custom Modal for Cart Details & Checkout Process -->
    <div id="customModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h4 id="modalTitle" class="text-xl font-bold">Título del Modal</h4>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="modalBody" class="text-gray-700 mb-6 max-h-80 overflow-y-auto">
                <!-- Content will be injected here -->
            </div>
            <div id="modalFooter" class="flex justify-end space-x-4">
                <!-- Buttons will be injected here -->
            </div>
        </div>
    </div>

    <script type="module">
        // Global variables for Firebase config and auth
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // Default userId

        let cart = [];
        const cartCountElement = document.getElementById('cart-count');
        const productListElement = document.getElementById('product-display-container');
        const mobileCategoriesContainer = document.getElementById('mobile-categories-container');
        const desktopMainCategoriesContainer = document.getElementById('desktop-main-categories-container');
        const subcategoryPillsContainer = document.getElementById('subcategory-pills-container');
        const notificationMessageElement = document.getElementById('notification-message');
        const productSectionTitle = document.getElementById('product-section-title');
        const noProductsMessage = document.getElementById('no-products-message');
        const sidebarCategoriesList = document.getElementById('sidebar-categories-list'); // Element for sidebar categories
        const viewMoreProductsContainer = document.getElementById('view-more-products-container'); // Container for "VER MÁS PRODUCTOS" button

        // Modal elements
        const customModal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const modalFooter = document.getElementById('modalFooter');
        const closeModalBtn = document.getElementById('closeModalBtn');

        // Search elements
        const searchToggleButton = document.getElementById('search-toggle-button');
        const searchInput = document.getElementById('search-input');
        
        // Filter elements
        const sortFilterToggle = document.getElementById('sort-filter-toggle');
        const sortFilterDropdown = document.getElementById('sort-filter-dropdown');
        const currentSortDisplay = document.getElementById('current-sort-display');


        // Checkout state variables
        let checkoutData = {};
        let currentStep = 0; // 0 for cart display, 1-4 for checkout steps
        const totalSteps = 4; // Total number of checkout steps

        // Global filter and pagination states
        let activeCategory = 'Inicio'; // Default filter on load
        let activeSubcategory = 'Todos'; // Default filter
        let currentSearchQuery = ''; // Current search input value
        let isDesktopCategoriesExpanded = false; // State to control category bar expansion on desktop

        let productsPerPage = 12; // Default for normal categories (3 rows * 4 columns)
        let initialHomeAndBestsellersLimit = 8; // For 'Inicio' and 'Los más vendidos' (2 rows * 4 columns)
        let bestsellersLimit = 4; // For 'Los más vendidos'
        let currentProductsDisplayedCount = 0; // Tracks how many products are currently shown in the main section
        let currentSortOrder = 'default'; // 'default', 'alpha_asc', 'alpha_desc', 'price_asc', 'price_desc', 'discount_desc'


        // Product data with wholesale and unit prices (expanded to ~50 products)
        const products = [
            { id: 'prod1', name: 'Aceite de Girasol', category: 'Aceites y Vinagres', subcategory: 'Aceites', imageUrl: 'https://placehold.co/300x200/FFD700/000000?text=Aceite+Girasol', unitPrice: 2500, wholesalePrice: 2000, wholesaleQuantity: 6, stock: 100, description: 'Aceite de girasol de primera calidad.' },
            { id: 'prod2', name: 'Arroz Largo Fino', category: 'Comestibles', subcategory: 'Arroz y Legumbres', imageUrl: 'https://placehold.co/300x200/C0C0C0/000000?text=Arroz+Largo+Fino', unitPrice: 1200, wholesalePrice: 900, wholesaleQuantity: 10, stock: 200, description: 'Arroz de grano largo, ideal para guarniciones.' },
            { id: 'prod3', name: 'Leche Entera Larga Vida', category: 'Lácteos y Frescos', subcategory: 'Leches', imageUrl: 'https://placehold.co/300x200/FFFFFF/000000?text=Leche+Entera+UHT', unitPrice: 1000, wholesalePrice: 750, wholesaleQuantity: 12, stock: 150, description: 'Leche UHT, pack familiar.' },
            { id: 'prod4', name: 'Fideos Secos Tirabuzón', category: 'Comestibles', subcategory: 'Pastas', imageUrl: 'https://placehold.co/300x200/A52A2A/FFFFFF?text=Fideos+Tirabuzon', unitPrice: 800, wholesalePrice: 600, wholesaleQuantity: 15, stock: 300, description: 'Fideos de trigo candeal, cocción rápida.' },
            { id: 'prod5', name: 'Detergente Líquido', category: 'Limpieza', subcategory: 'Lavandería', imageUrl: 'https://placehold.co/300x200/4682B4/FFFFFF?text=Detergente+Liquido', unitPrice: 3200, wholesalePrice: 2800, wholesaleQuantity: 4, stock: 80, description: 'Detergente concentrado para ropa.' },
            { id: 'prod6', name: 'Jugo en Polvo Naranja', category: 'Bebidas', subcategory: 'Jugos', imageUrl: 'https://placehold.co/300x200/FFA500/FFFFFF?text=Jugo+Polvo+Naranja', unitPrice: 500, wholesalePrice: 350, wholesaleQuantity: 20, stock: 250, description: 'Rinde 1 litro, sabor naranja.' },
            { id: 'prod7', name: 'Café Molido Clásico', category: 'Desayuno y Merienda', subcategory: 'Café', imageUrl: 'https://placehold.co/300x200/8B4513/FFFFFF?text=Cafe+Molido', unitPrice: 4000, wholesalePrice: 3500, wholesaleQuantity: 5, stock: 90, description: 'Café de tueste medio, aroma intenso.' },
            { id: 'prod8', name: 'Gaseosa Cola', category: 'Bebidas', subcategory: 'Gaseosas', imageUrl: 'https://placehold.co/300x200/B22222/FFFFFF?text=Gaseosa+Cola+2L', unitPrice: 1800, wholesalePrice: 1400, wholesaleQuantity: 8, stock: 120, description: 'Refrescante bebida cola, 2.25L.' },
            { id: 'prod9', name: 'Papel Higiénico', category: 'Limpieza', subcategory: 'Papel y Servilletas', imageUrl: 'https://placehold.co/300x200/ADD8E6/000000?text=Papel+Higienico', unitPrice: 5000, wholesalePrice: 4200, wholesaleQuantity: 3, stock: 70, description: 'Paquete de 6 rollos, doble hoja.' },
            { id: 'prod10', name: 'Atún en Lata', category: 'Comestibles', subcategory: 'Enlatados', imageUrl: 'https://placehold.co/300x200/5F9EA0/FFFFFF?text=Atun+Enlatado', unitPrice: 1500, wholesalePrice: 1100, wholesaleQuantity: 10, stock: 110, description: 'Atún en aceite, alto en proteínas.' },
            { id: 'prod11', name: 'Azúcar Refinada', category: 'Comestibles', subcategory: 'Endulzantes', imageUrl: 'https://placehold.co/300x200/F0F8FF/000000?text=Azucar+1kg', unitPrice: 900, wholesalePrice: 700, wholesaleQuantity: 10, stock: 180, description: 'Azúcar de caña, 1kg.' },
            { id: 'prod12', name: 'Yerba Mate Suave', category: 'Desayuno y Merienda', subcategory: 'Yerba Mate', imageUrl: 'https://placehold.co/300x200/A0522D/FFFFFF?text=Yerba+Mate+Suave', unitPrice: 2800, wholesalePrice: 2200, wholesaleQuantity: 5, stock: 130, description: 'Yerba mate con bajo contenido de polvo.' },
            { id: 'prod13', name: 'Harina de Trigo 000', category: 'Comestibles', subcategory: 'Harinas y Premezclas', imageUrl: 'https://placehold.co/300x200/F5DEB3/000000?text=Harina+Trigo+000', unitPrice: 700, wholesalePrice: 550, wholesaleQuantity: 12, stock: 250, description: 'Harina de trigo de fuerza, 1kg.' },
            { id: 'prod14', name: 'Sal Fina Cocina', category: 'Comestibles', subcategory: 'Condimentos', imageUrl: 'https://placehold.co/300x200/F8F8F8/000000?text=Sal+Fina', unitPrice: 400, wholesalePrice: 300, wholesaleQuantity: 20, stock: 350, description: 'Sal de mesa, 500g.' },
            { id: 'prod15', name: 'Pan de Molde Blanco', category: 'Panadería y Pastelería', subcategory: 'Panes', imageUrl: 'https://placehold.co/300x200/FFF8DC/000000?text=Pan+Molde', unitPrice: 1600, wholesalePrice: 1300, wholesaleQuantity: 6, stock: 60, description: 'Pan lactal fresco, 340g.' },
            { id: 'prod16', name: 'Mermelada Durazno', category: 'Desayuno y Merienda', subcategory: 'Dulces y Mermeladas', imageUrl: 'https://placehold.co/300x200/FFDAB9/000000?text=Mermelada+Durazno', unitPrice: 1300, wholesalePrice: 1000, wholesaleQuantity: 8, stock: 95, description: 'Mermelada artesanal de durazno, 300g.' },
            { id: 'prod17', name: 'Crema de Leche', category: 'Lácteos y Frescos', subcategory: 'Cremas y Untables', imageUrl: 'https://placehold.co/300x200/F5FFFA/000000?text=Crema+Leche', unitPrice: 1100, wholesalePrice: 900, wholesaleQuantity: 10, stock: 75, description: 'Crema de leche pasteurizada, 200ml.' },
            { id: 'prod18', name: 'Lavandina Cloro', category: 'Limpieza', subcategory: 'Desinfectantes', imageUrl: 'https://placehold.co/300x200/E0FFFF/000000?text=Lavandina', unitPrice: 950, wholesalePrice: 750, wholesaleQuantity: 6, stock: 110, description: 'Lavandina concentrada, 1L.' },
            { id: 'prod19', name: 'Alcohol en Gel', category: 'Limpieza', subcategory: 'Cuidado Personal', imageUrl: 'https://placehold.co/300x200/F0F8FF/000000?text=Alcohol+Gel', unitPrice: 1800, wholesalePrice: 1500, wholesaleQuantity: 5, stock: 85, description: 'Alcohol en gel antibacterial, 500ml.' },
            { id: 'prod20', name: 'Mayonesa Clásica', category: 'Aderezos y Salsas', subcategory: 'Salsas Frías', imageUrl: 'https://placehold.co/300x200/FDF5E6/000000?text=Mayonesa', unitPrice: 1400, wholesalePrice: 1100, wholesaleQuantity: 8, stock: 140, description: 'Mayonesa tradicional, 250g.' },
            { id: 'prod21', name: 'Ketchup Tomate', category: 'Aderezos y Salsas', subcategory: 'Salsas Frías', imageUrl: 'https://placehold.co/300x200/B22222/FFFFFF?text=Ketchup', unitPrice: 1300, wholesalePrice: 1000, wholesaleQuantity: 8, stock: 100, description: 'Salsa de tomate dulce, 300g.' },
            { id: 'prod22', name: 'Galletas de Agua', category: 'Panadería y Pastelería', subcategory: 'Galletas', imageUrl: 'https://placehold.co/300x200/F5F5DC/000000?text=Galletas+Agua', unitPrice: 600, wholesalePrice: 450, wholesaleQuantity: 15, stock: 200, description: 'Galletas saladas para acompañar comidas.' },
            { id: 'prod23', name: 'Queso Cremoso', category: 'Lácteos y Frescos', subcategory: 'Quesos', imageUrl: 'https://placehold.co/300x200/F0F8FF/000000?text=Queso+Cremoso', unitPrice: 4500, wholesalePrice: 3800, wholesaleQuantity: 3, stock: 50, description: 'Queso fresco para sándwiches o postres.' },
            { id: 'prod24', name: 'Manteca sin Sal', category: 'Lácteos y Frescos', subcategory: 'Cremas y Untables', imageUrl: 'https://placehold.co/300x200/FFFFF0/000000?text=Manteca+Sin+Sal', unitPrice: 1800, wholesalePrice: 1500, wholesaleQuantity: 8, stock: 70, description: 'Manteca de primera calidad, 200g.' },
            { id: 'prod25', name: 'Detergente para Platos', category: 'Limpieza', subcategory: 'Cocina', imageUrl: 'https://placehold.co/300x200/87CEEB/000000?text=Detergente+Platos', unitPrice: 1200, wholesalePrice: 950, wholesaleQuantity: 6, stock: 160, description: 'Detergente concentrado, 750ml.' },
            { id: 'prod26', name: 'Esponja de Cocina', category: 'Limpieza', subcategory: 'Cocina', imageUrl: 'https://placehold.co/300x200/E6E6FA/000000?text=Esponja+Cocina', unitPrice: 300, wholesalePrice: 200, wholesaleQuantity: 12, stock: 300, description: 'Esponja doble cara para limpieza.' },
            { id: 'prod27', name: 'Servilletas de Papel', category: 'Limpieza', subcategory: 'Papel y Servilletas', imageUrl: 'https://placehold.co/300x200/F8F8FF/000000?text=Servilletas+Papel', unitPrice: 800, wholesalePrice: 600, wholesaleQuantity: 10, stock: 150, description: 'Paquete de 100 servilletas.' },
            { id: 'prod28', name: 'Vino Tinto Malbec', category: 'Bebidas', subcategory: 'Vinos', imageUrl: 'https://placehold.co/300x200/800000/FFFFFF?text=Vino+Malbec', unitPrice: 6000, wholesalePrice: 5000, wholesaleQuantity: 3, stock: 40, description: 'Vino tinto joven, 750ml.' },
            { id: 'prod29', name: 'Cerveza Lager', category: 'Bebidas', subcategory: 'Cervezas', imageUrl: 'https://placehold.co/300x200/FFD700/000000?text=Cerveza+Lager', unitPrice: 1500, wholesalePrice: 1200, wholesaleQuantity: 6, stock: 90, description: 'Cerveza rubia clásica, lata 473ml.' },
            { id: 'prod30', name: 'Galletas Dulces Variadas', category: 'Panadería y Pastelería', subcategory: 'Galletas', imageUrl: 'https://placehold.co/300x200/FAEBD7/000000?text=Galletas+Dulces', unitPrice: 900, wholesalePrice: 700, wholesaleQuantity: 10, stock: 180, description: 'Surtido de galletas dulces, 300g.' },
            { id: 'prod31', name: 'Yogur Firme Vainilla', category: 'Lácteos y Frescos', subcategory: 'Yogures y Postres', imageUrl: 'https://placehold.co/300x200/F0FFF0/000000?text=Yogur+Vainilla', unitPrice: 700, wholesalePrice: 550, wholesaleQuantity: 12, stock: 140, description: 'Yogur cremoso sabor vainilla, 125g.' },
            { id: 'prod32', name: 'Gaseosa Lima-Limón', category: 'Bebidas', subcategory: 'Gaseosas', imageUrl: 'https://placehold.co/300x200/ADFF2F/000000?text=Gaseosa+Lima-Limon', unitPrice: 1800, wholesalePrice: 1400, wholesaleQuantity: 8, stock: 100, description: 'Bebida gaseosa refrescante, 2.25L.' },
            { id: 'prod33', name: 'Jugo de Naranja Brik', category: 'Bebidas', subcategory: 'Jugos', imageUrl: 'https://placehold.co/300x200/FFA500/FFFFFF?text=Jugo+Naranja+Brik', unitPrice: 1700, wholesalePrice: 1300, wholesaleQuantity: 6, stock: 90, description: 'Jugo de naranja natural, 1L.' },
            { id: 'prod34', name: 'Papas Fritas Snacks', category: 'Snacks', subcategory: 'Papas Fritas', imageUrl: 'https://placehold.co/300x200/D2B48C/000000?text=Papas+Fritas', unitPrice: 1000, wholesalePrice: 800, wholesaleQuantity: 10, stock: 120, description: 'Papas fritas clásicas, 100g.' },
            { id: 'prod35', name: 'Cereales de Maíz', category: 'Desayuno y Merienda', subcategory: 'Cereales', imageUrl: 'https://placehold.co/300x200/F5DEB3/000000?text=Cereales+Maiz', unitPrice: 2200, wholesalePrice: 1800, wholesaleQuantity: 6, stock: 70, description: 'Cereales de maíz tostado, 500g.' },
            { id: 'prod36', name: 'Cacao en Polvo', category: 'Desayuno y Merienda', subcategory: 'Cereales', imageUrl: 'https://placehold.co/300x200/D2691E/FFFFFF?text=Cacao+Polvo', unitPrice: 1500, wholesalePrice: 1200, wholesaleQuantity: 8, stock: 80, description: 'Cacao instantáneo para leche.' },
            { id: 'prod37', name: 'Sopa Instantánea Pollo', category: 'Comestibles', subcategory: 'Sopas y Caldos', imageUrl: 'https://placehold.co/300x200/F0F8FF/000000?text=Sopa+Pollo', unitPrice: 400, wholesalePrice: 300, wholesaleQuantity: 15, stock: 250, description: 'Sopa deshidratada sabor pollo.' },
            { id: 'prod38', name: 'Gelatina Frutilla', category: 'Postres', subcategory: 'Gelatinas', imageUrl: 'https://placehold.co/300x200/FF6347/FFFFFF?text=Gelatina+Frutilla', unitPrice: 350, wholesalePrice: 250, wholesaleQuantity: 20, stock: 300, description: 'Postre de gelatina sabor frutilla.' },
            { id: 'prod39', name: 'Cebolla Fresca', category: 'Frutas y Verduras', subcategory: 'Verduras', imageUrl: 'https://placehold.co/300x200/FFE4B5/000000?text=Cebolla+Fresca', unitPrice: 600, wholesalePrice: 400, wholesaleQuantity: 5, stock: 100, description: 'Cebollas grandes, por kg.' },
            { id: 'prod40', name: 'Manzana Roja', category: 'Frutas y Verduras', subcategory: 'Frutas', imageUrl: 'https://placehold.co/300x200/FF0000/FFFFFF?text=Manzana+Roja', unitPrice: 900, wholesalePrice: 700, wholesaleQuantity: 6, stock: 80, description: 'Manzanas frescas y jugosas, por kg.' },
            { id: 'prod41', name: 'Agua Mineral sin Gas', category: 'Bebidas', subcategory: 'Aguas', imageUrl: 'https://placehold.co/300x200/ADD8E6/000000?text=Agua+Sin+Gas', unitPrice: 500, wholesalePrice: 400, wholesaleQuantity: 12, stock: 200, description: 'Agua purificada, 1.5L.' },
            { id: 'prod42', name: 'Agua Mineral con Gas', category: 'Bebidas', subcategory: 'Aguas', imageUrl: 'https://placehold.co/300x200/ADD8E6/000000?text=Agua+Con+Gas', unitPrice: 550, wholesalePrice: 450, wholesaleQuantity: 12, stock: 180, description: 'Agua con burbujas, 1.5L.' },
            { id: 'prod43', name: 'Pañales para Bebé', category: 'Bebés y Niños', subcategory: 'Pañales', imageUrl: 'https://placehold.co/300x200/E0FFFF/000000?text=Pañales+Beb%C3%A9', unitPrice: 8000, wholesalePrice: 7000, wholesaleQuantity: 2, stock: 30, description: 'Pañales ultra absorbentes, pack grande.' },
            { id: 'prod44', name: 'Toallitas Húmedas', category: 'Bebés y Niños', subcategory: 'Cuidado del Bebé', imageUrl: 'https://placehold.co/300x200/F0F8FF/000000?text=Toallitas+Humedas', unitPrice: 1500, wholesalePrice: 1200, wholesaleQuantity: 5, stock: 100, description: 'Toallitas húmedas hipoalergénicas.' },
            { id: 'prod45', name: 'Champú para Cabello', category: 'Cuidado Personal', subcategory: 'Cuidado del Cabello', imageUrl: 'https://placehold.co/300x200/B0E0E6/000000?text=Champ%C3%BA', unitPrice: 2500, wholesalePrice: 2000, wholesaleQuantity: 4, stock: 60, description: 'Champú hidratante, 400ml.' },
            { id: 'prod46', name: 'Acondicionador', category: 'Cuidado Personal', subcategory: 'Cuidado del Cabello', imageUrl: 'https://placehold.co/300x200/B0E0E6/000000?text=Acondicionador', unitPrice: 2500, wholesalePrice: 2000, wholesaleQuantity: 4, stock: 60, description: 'Acondicionador para todo tipo de cabello, 400ml.' },
            { id: 'prod47', name: 'Pasta Dental', category: 'Cuidado Personal', subcategory: 'Higiene Bucal', imageUrl: 'https://placehold.co/300x200/F8F8FF/000000?text=Pasta+Dental', unitPrice: 1000, wholesalePrice: 800, wholesaleQuantity: 8, stock: 150, description: 'Pasta dental con flúor, 90g.' },
            { id: 'prod48', name: 'Cepillo de Dientes', category: 'Cuidado Personal', subcategory: 'Higiene Bucal', imageUrl: 'https://placehold.co/300x200/F8F8FF/000000?text=Cepillo+Dientes', unitPrice: 600, wholesalePrice: 450, wholesaleQuantity: 10, stock: 200, description: 'Cepillo de dientes de cerdas suaves.' },
            { id: 'prod49', name: 'Jabón de Tocador', category: 'Cuidado Personal', subcategory: 'Higiene Corporal', imageUrl: 'https://placehold.co/300x200/FFE4E1/000000?text=Jab%C3%B3n+Tocador', unitPrice: 400, wholesalePrice: 300, wholesaleQuantity: 12, stock: 220, description: 'Jabón en barra, aroma floral.' },
            { id: 'prod50', name: 'Desodorante Aerosol', category: 'Cuidado Personal', subcategory: 'Higiene Corporal', imageUrl: 'https://placehold.co/300x200/E0FFFF/000000?text=Desodorante', unitPrice: 1800, wholesalePrice: 1400, wholesaleQuantity: 6, stock: 90, description: 'Desodorante antitranspirante, 150ml.' }
        ];

        // Log the total number of products to confirm
        console.log("Total products available:", products.length);

        // Extract unique categories and subcategories
        const allProductCategories = [...new Set(products.map(p => p.category))].sort(); // Store original sorted list
        const subcategories = [...new Set(products.map(p => p.subcategory))];

        // --- Firebase Initialization and Authentication ---
        window.onload = async function() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in anonymously or with custom token
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // Listen for auth state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid; // Update userId
                        console.log("Firebase user authenticated:", userId);
                        // Fetch cart data after authentication
                        setupCartListener(userId);
                    } else {
                        userId = crypto.randomUUID(); // Anonymous user ID
                        console.log("Firebase user is anonymous:", userId);
                        setupCartListener(userId); // Still set up listener for anonymous user
                    }
                });

                // Initial display of elements
                displayCategories();
                renderProductsBasedOnFiltersAndSearch(); // Initial display: 'Inicio' products
                updateSortDisplay(); // Initialize sort display text

            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                // Fallback: display products without Firebase if error occurs
                displayCategories();
                renderProductsBasedOnFiltersAndSearch(); // Initial display: 'Inicio' products
                updateSortDisplay(); // Initialize sort display text
                showModal("Error de Conexión", "No se pudo conectar con los servicios de Firebase. Algunas funcionalidades pueden no estar disponibles.", [{ text: "Entendido", action: "close" }]);
            }
        };

        // --- Firebase Cart Listener ---
        function setupCartListener(currentUserId) {
            const cartCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/cart`);
            onSnapshot(cartCollectionRef, (snapshot) => {
                cart = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateCartCount();
                console.log("Cart updated from Firestore:", cart);
                // If cart modal is open and it's the cart view, refresh its content
                if (!customModal.classList.contains('hidden') && currentStep === 0) {
                    displayCartContents();
                }
            }, (error) => {
                console.error("Error listening to cart changes:", error);
                showModal("Error del Carrito", "No se pudieron cargar los datos del carrito en tiempo real.", [{ text: "Cerrar", action: "close" }]);
            });
        }


        // --- UI Helper Functions ---

        // Generic modal show function (used for confirmations and errors)
        function showModal(title, bodyHtml, buttons) {
            modalTitle.innerHTML = title;
            modalBody.innerHTML = bodyHtml;
            modalFooter.innerHTML = ''; // Clear previous buttons

            buttons.forEach(btn => {
                const buttonElement = document.createElement('button');
                buttonElement.textContent = btn.text;
                buttonElement.className = 'px-4 py-2 rounded-md transition-colors duration-200';
                if (btn.action === 'close') {
                    buttonElement.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                    buttonElement.onclick = () => customModal.classList.add('hidden');
                } else if (btn.action === 'confirm') {
                    buttonElement.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                    buttonElement.onclick = () => {
                        btn.callback(); // Execute callback
                        customModal.classList.add('hidden'); // Close after action
                    };
                } else if (btn.action === 'custom') {
                    // Applied text-white for custom buttons as requested
                    buttonElement.classList.add(btn.className || 'bg-blue-600', btn.color || 'text-white', btn.hover || 'hover:bg-blue-700');
                    buttonElement.onclick = () => {
                        if (btn.callback) btn.callback();
                        // Modal does not close by default for custom actions, unless callback handles it
                    };
                }
                modalFooter.appendChild(buttonElement);
            });

            customModal.classList.remove('hidden');
        }

        // Close modal button listener
        closeModalBtn.addEventListener('click', () => {
            customModal.classList.add('hidden');
            currentStep = 0; // Reset checkout process if modal is closed manually
        });

        // Function to show temporary notifications
        function showNotification(message, type = 'info') {
            notificationMessageElement.textContent = message;
            notificationMessageElement.classList.remove('hidden', 'bg-red-200', 'text-red-800', 'bg-green-200', 'text-green-800', 'bg-blue-200', 'text-blue-800');
            
            if (type === 'success') {
                notificationMessageElement.classList.add('bg-green-200', 'text-green-800');
            } else if (type === 'error') {
                notificationMessageElement.classList.add('bg-red-200', 'text-red-800');
            } else if (type === 'info') {
                notificationMessageElement.classList.add('bg-blue-200', 'text-blue-800');
            }

            // Trigger show animation
            notificationMessageElement.classList.add('show');

            setTimeout(() => {
                // Trigger hide animation
                notificationMessageElement.classList.remove('show');
                setTimeout(() => {
                    notificationMessageElement.classList.add('hidden'); // Fully hide after transition
                }, 300); // Match transition duration
            }, 1000); // Display for 1 second
        }


        // --- Category Display ---
        function displayCategories() {
            const specialCategories = ['Inicio', 'Los más vendidos'];
            const allCategoriesForMobileDisplay = [...specialCategories, ...allProductCategories, 'Todos'];

            // Mobile Categories (Pills)
            mobileCategoriesContainer.innerHTML = '';
            allCategoriesForMobileDisplay.forEach(category => {
                const button = document.createElement('button');
                button.textContent = category;
                button.className = `category-card ${activeCategory === category ? 'active' : ''}`;
                button.onclick = () => filterProductsByCategory(category);
                mobileCategoriesContainer.appendChild(button);
            });

            // Desktop Main Categories (Links)
            desktopMainCategoriesContainer.innerHTML = '';
            let categoriesToDisplayInDesktopNav = [];

            if (isDesktopCategoriesExpanded) {
                categoriesToDisplayInDesktopNav = [...specialCategories, ...allProductCategories, 'Todos'];
            } else {
                categoriesToDisplayInDesktopNav = [...specialCategories, ...allProductCategories.slice(0, 3)];
            }
            
            categoriesToDisplayInDesktopNav.forEach((category, index) => {
                const link = document.createElement('a');
                link.href = '#';
                link.textContent = category;
                link.className = `main-category-link ${activeCategory === category ? 'active' : ''}`;
                link.onclick = (e) => {
                    e.preventDefault();
                    isDesktopCategoriesExpanded = false; // Collapse when a specific category is chosen
                    filterProductsByCategory(category);
                };
                desktopMainCategoriesContainer.appendChild(link);
                if (index < categoriesToDisplayInDesktopNav.length - 1) {
                    const separator = document.createElement('span');
                    separator.textContent = '|';
                    separator.className = 'nav-separator';
                    desktopMainCategoriesContainer.appendChild(separator);
                }
            });

            // Add 'Ver Más Categorías' button if not already expanded and there are more product categories
            if (!isDesktopCategoriesExpanded && allProductCategories.length > 3) {
                if (categoriesToDisplayInDesktopNav.length > 0) {
                    const separator = document.createElement('span');
                    separator.textContent = '|';
                    separator.className = 'nav-separator';
                    desktopMainCategoriesContainer.appendChild(separator);
                }
                const link = document.createElement('a');
                link.href = '#';
                link.textContent = 'Ver Más Categorías';
                link.className = `main-category-link`;
                link.onclick = (e) => {
                    e.preventDefault();
                    isDesktopCategoriesExpanded = true;
                    displayCategories(); // Re-render to show all desktop categories
                };
                desktopMainCategoriesContainer.appendChild(link);
            }


            // Sidebar Categories List
            sidebarCategoriesList.innerHTML = '';
            const visibleSidebarCategories = allProductCategories.slice(0, 5); // Show first 5 categories in sidebar
            visibleSidebarCategories.forEach(category => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<a href="#" class="block text-md font-medium text-gray-700 hover:text-blue-600" onclick="filterProductsByCategory('${category}'); closeSidebar();">${category}</a>`;
                sidebarCategoriesList.appendChild(listItem);
            });
            if (allProductCategories.length > 5) {
                const seeAllLi = document.createElement('li');
                seeAllLi.innerHTML = `<a href="#" class="block text-md font-semibold text-blue-600 hover:text-blue-700 mt-2" onclick="filterProductsByCategory('Todos'); closeSidebar();">Ver Todas las Categorías</a>`;
                sidebarCategoriesList.appendChild(seeAllLi);
            }
        }

        window.closeSidebar = function() { // Made global for onclick in HTML
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('hamburger-menu').classList.remove('open');
        }

        // --- Subcategory Display ---
        function displaySubcategories() {
            subcategoryPillsContainer.innerHTML = '';
            let filteredSubcategories = [];
            const isSpecificCategorySelected = !['Inicio', 'Los más vendidos', 'Todos'].includes(activeCategory);

            if (isSpecificCategorySelected) {
                filteredSubcategories = ['Todos', ...new Set(products.filter(p => p.category === activeCategory).map(p => p.subcategory))];
            } else {
                filteredSubcategories = [];
            }

            if (filteredSubcategories.length === 0 || (filteredSubcategories.length === 1 && filteredSubcategories[0] === 'Todos')) {
                subcategoryPillsContainer.classList.add('hidden');
            } else {
                subcategoryPillsContainer.classList.remove('hidden');
            }

            filteredSubcategories.forEach(sub => {
                const button = document.createElement('button');
                button.textContent = sub;
                button.className = `subcategory-pill ${activeSubcategory === sub ? 'active' : ''}`;
                button.onclick = () => filterProductsBySubcategory(sub);
                subcategoryPillsContainer.appendChild(button);
            });
        }

        // --- Price Formatting Function ---
        function formatPrice(price) {
            // Formats number with thousands separator and no decimal places for Argentine locale
            return price.toLocaleString('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        // --- Product Display ---
        function displayProducts(productsToDisplay) {
            productListElement.innerHTML = ''; // Clear previous content
            noProductsMessage.classList.add('hidden'); // Hide no products message by default

            if (productsToDisplay.length === 0) {
                productListElement.innerHTML = '';
                noProductsMessage.classList.remove('hidden');
                return;
            }

            productListElement.classList.add('product-grid'); // Ensure grid class is present

            productsToDisplay.forEach(product => {
                const productInCart = cart.find(item => item.productId === product.id);
                const quantityInCart = productInCart ? productInCart.quantity : 0;

                const productCard = document.createElement('div');
                // Use flex-col and justify-between to push content to bottom
                productCard.className = `bg-white rounded-lg shadow-md overflow-hidden transform transition duration-300 hover:scale-105 flex flex-col product-card-item max-w-sm`;
                productCard.innerHTML = `
                    <img src="${product.imageUrl}" alt="${product.name}" class="w-full h-48 object-cover">
                    <div class="p-4 flex-grow flex flex-col justify-between">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-2">${product.name}</h4>
                            <p class="text-gray-600 text-sm mb-3 h-10 overflow-hidden line-clamp-2">${product.description}</p>
                            <!-- Use h-10 and line-clamp-2 for consistent description height -->
                        </div>
                        <div>
                            <div class="flex flex-col mb-4">
                                <!-- Wholesale Price Display -->
                                <div class="flex items-baseline">
                                    <span class="product-price-display" id="wholesale-price-${product.id}">
                                        $${formatPrice(product.wholesalePrice)}
                                    </span>
                                    <span class="ml-2 text-sm text-gray-500" id="wholesale-note-${product.id}">
                                        Mayorista
                                    </span>
                                </div>

                                <!-- Unit Price Display -->
                                <div class="flex items-baseline mt-1">
                                    <span class="product-price-display" id="unit-price-${product.id}">
                                        $${formatPrice(product.unitPrice)}
                                    </span>
                                    <span class="ml-2 text-sm text-gray-500" id="unit-note-${product.id}">
                                        por unidad
                                    </span>
                                </div>

                                <!-- Dynamic Price Message -->
                                <p id="price-message-${product.id}" class="text-sm mt-2"></p>

                                <!-- Wholesale Quantity Minimum -->
                                <p class="text-xs text-gray-700 mt-2">
                                    <span class="font-semibold">Mayorista:</span> a partir de ${product.wholesaleQuantity} unidades.
                                </p>
                            </div>
                            <div class="flex items-center justify-between mt-auto">
                                <div class="flex items-center border border-gray-300 rounded-md flex-shrink-0">
                                    <button class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-l-md" onclick="updateQuantity('${product.id}', -1)">-</button>
                                    <input type="number" id="qty-${product.id}" value="${quantityInCart}" min="0" class="w-16 text-center border-x border-gray-300 appearance-none [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none focus:outline-none" onchange="manualQuantityUpdate('${product.id}', this.value)">
                                    <button class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-r-md" onclick="updateQuantity('${product.id}', 1)">+</button>
                                </div>
                                <button class="ml-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200 flex-shrink-0" onclick="addToCart('${product.id}')">
                                    Añadir
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                productListElement.appendChild(productCard);
                updateDisplayedPrice(product.id);
            });
        }

        // --- Filtering and Sorting Logic ---
        function filterProductsByCategory(category) {
            currentSearchQuery = '';
            searchInput.value = '';
            activeSubcategory = 'Todos';
            activeCategory = category;
            isDesktopCategoriesExpanded = false; // Collapse desktop categories on category change

            resetPagination(); // Reset pagination when category changes
            displayCategories();
            displaySubcategories();
            renderProductsBasedOnFiltersAndSearch();
        }

        function filterProductsBySubcategory(subcategory) {
            activeSubcategory = subcategory;
            currentSearchQuery = '';
            searchInput.value = '';
            resetPagination(); // Reset pagination when subcategory changes
            displaySubcategories();
            renderProductsBasedOnFiltersAndSearch();
        }

        window.setSortOrder = function(order) {
            currentSortOrder = order;
            updateSortDisplay(); // Update the text in the summary tag
            resetPagination(); // Reset pagination when sort order changes
            renderProductsBasedOnFiltersAndSearch();
            sortFilterDropdown.classList.add('hidden'); // Close dropdown after selection
        }

        function updateSortDisplay() {
            let displayText = 'Defecto';
            switch (currentSortOrder) {
                case 'alpha_asc': displayText = 'Alfabético (A-Z)'; break;
                case 'alpha_desc': displayText = 'Alfabético (Z-A)'; break;
                case 'price_asc': displayText = 'Precio (Menor a Mayor)'; break;
                case 'price_desc': displayText = 'Precio (Mayor a Menor)'; break;
                case 'discount_desc': displayText = 'Mejor Descuento'; break;
            }
            currentSortDisplay.textContent = displayText;
            // Also ensure the radio button is checked
            const radio = document.querySelector(`input[name="sortOrder"][value="${currentSortOrder}"]`);
            if (radio) {
                radio.checked = true;
            }
        }


        function resetPagination() {
            currentProductsDisplayedCount = 0; // Reset to show initial batch
        }

        function renderProductsBasedOnFiltersAndSearch() {
            let filteredProducts = products;
            let sectionTitle = "Nuestros Productos";
            let limitForDisplay = null; // No limit by default for normal categories
            
            // 1. Apply Search Filter
            if (currentSearchQuery) {
                filteredProducts = products.filter(p => p.name.toLowerCase().includes(currentSearchQuery.toLowerCase()) ||
                                               p.description.toLowerCase().includes(currentSearchQuery.toLowerCase()));
                sectionTitle = `Resultados para "${currentSearchQuery}"`;
                // Subcategories hidden when searching
                subcategoryPillsContainer.classList.add('hidden');
            } else {
                // 2. Apply Category/Subcategory Filter
                if (activeCategory === 'Inicio') {
                    // For Inicio, show a limited number of products
                    filteredProducts = products; // Start with all products to then limit
                    sectionTitle = "Bienvenido";
                    limitForDisplay = initialHomeAndBestsellersLimit; // Limit to 8 for initial display
                    subcategoryPillsContainer.classList.add('hidden');
                } else if (activeCategory === 'Los más vendidos') {
                    // For Los más vendidos, show a limited number of products
                    filteredProducts = products.slice(0, bestsellersLimit); // Limit to 4 for bestsellers
                    sectionTitle = "Los Más Vendidos";
                    limitForDisplay = bestsellersLimit; // Explicitly limit to 4 for this section
                    subcategoryPillsContainer.classList.add('hidden');
                } else if (activeCategory === 'Todos') {
                    // 'Todos' category explicitly selected (shows ALL products)
                    filteredProducts = products;
                    sectionTitle = "Todos Nuestros Productos";
                    subcategoryPillsContainer.classList.add('hidden');
                } else {
                    // A specific product category is selected
                    filteredProducts = filteredProducts.filter(p => p.category === activeCategory);
                    sectionTitle = `Productos en ${activeCategory}`;
                    if (activeSubcategory !== 'Todos') {
                        filteredProducts = filteredProducts.filter(p => p.subcategory === activeSubcategory);
                        sectionTitle += ` > ${activeSubcategory}`;
                    }
                    displaySubcategories(); // Re-render subcategories (will show if category selected)
                }
            }
            
            // 3. Apply Sorting
            let sortedProducts = [...filteredProducts]; // Create a copy to sort
            switch (currentSortOrder) {
                case 'alpha_asc':
                    sortedProducts.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'alpha_desc':
                    sortedProducts.sort((a, b) => b.name.localeCompare(a.name));
                    break;
                case 'price_asc':
                    sortedProducts.sort((a, b) => {
                        const priceA = a.quantity >= a.wholesaleQuantity ? a.wholesalePrice : a.unitPrice;
                        const priceB = b.quantity >= b.wholesaleQuantity ? b.wholesalePrice : b.unitPrice;
                        return priceA - priceB;
                    });
                    break;
                case 'price_desc':
                    sortedProducts.sort((a, b) => {
                        const priceA = a.quantity >= a.wholesaleQuantity ? a.wholesalePrice : a.unitPrice;
                        const priceB = b.quantity >= b.wholesaleQuantity ? b.wholesalePrice : b.unitPrice;
                        return priceB - priceA;
                    });
                    break;
                case 'discount_desc':
                    // Calculate discount: assuming unitPrice - wholesalePrice is the discount
                    sortedProducts.sort((a, b) => {
                        const discountA = a.unitPrice - a.wholesalePrice;
                        const discountB = b.unitPrice - b.wholesalePrice;
                        return discountB - discountA; // Descending order for best discount
                    });
                    break;
                case 'default':
                default:
                    // No specific sort, keep original order or default order from data
                    break;
            }

            productSectionTitle.textContent = sectionTitle;

            // 4. Apply Pagination/Limit for display
            let productsToDisplayFinal = [];
            if (limitForDisplay !== null) {
                // For 'Inicio' and 'Los más vendidos', we have a fixed initial limit
                productsToDisplayFinal = sortedProducts.slice(0, limitForDisplay);
                currentProductsDisplayedCount = productsToDisplayFinal.length;
            } else {
                // For other categories, apply incremental pagination
                if (currentProductsDisplayedCount === 0) { // First load for a category
                    currentProductsDisplayedCount = productsPerPage;
                }
                productsToDisplayFinal = sortedProducts.slice(0, currentProductsDisplayedCount);
            }

            displayProducts(productsToDisplayFinal); // Render the products

            // 5. Manage "VER MÁS PRODUCTOS" / "VER TODOS LOS PRODUCTOS" button
            viewMoreProductsContainer.innerHTML = '';
            if (currentSearchQuery) {
                // No "view more" button when searching
                viewMoreProductsContainer.classList.add('hidden');
            } else if (activeCategory === 'Inicio' || activeCategory === 'Los más vendidos') {
                if (sortedProducts.length > limitForDisplay) {
                    const button = document.createElement('button');
                    button.textContent = 'VER TODOS LOS PRODUCTOS';
                    button.className = 'mt-8 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-200 block mx-auto';
                    button.onclick = () => {
                        activeCategory = 'Todos'; // Change active category to 'Todos'
                        isDesktopCategoriesExpanded = false; // Ensure categories list collapses
                        displayCategories(); // Update category bar
                        resetPagination(); // Reset pagination for 'Todos'
                        renderProductsBasedOnFiltersAndSearch(); // Re-render to show all products
                        window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top
                    };
                    viewMoreProductsContainer.classList.remove('hidden');
                    viewMoreProductsContainer.appendChild(button);
                } else {
                    viewMoreProductsContainer.classList.add('hidden');
                }
            } else if (sortedProducts.length > currentProductsDisplayedCount) {
                const button = document.createElement('button');
                button.textContent = 'VER MÁS PRODUCTOS';
                button.className = 'mt-8 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-200 block mx-auto';
                button.onclick = () => {
                    currentProductsDisplayedCount += productsPerPage;
                    renderProductsBasedOnFiltersAndSearch(); // Load more products
                };
                viewMoreProductsContainer.classList.remove('hidden');
                viewMoreProductsContainer.appendChild(button);
            } else {
                viewMoreProductsContainer.classList.add('hidden');
            }

            updateSortDisplay(); // Ensure sort display is correct on every render
        }


        // --- Quantity and Price Logic ---
        window.updateQuantity = function(productId, change) {
            const qtyInput = document.getElementById(`qty-${productId}`);
            let currentQty = parseInt(qtyInput.value);
            currentQty = Math.max(0, currentQty + change);
            qtyInput.value = currentQty;
            updateDisplayedPrice(productId);
        };

        window.manualQuantityUpdate = function(productId, value) {
            const qtyInput = document.getElementById(`qty-${productId}`);
            let currentQty = parseInt(value);
            if (isNaN(currentQty) || currentQty < 0) {
                currentQty = 0;
            }
            qtyInput.value = currentQty;
            updateDisplayedPrice(productId);
        };

        function updateDisplayedPrice(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const qtyInput = document.getElementById(`qty-${productId}`);
            const currentQty = parseInt(qtyInput.value);

            const wholesalePriceElem = document.getElementById(`wholesale-price-${product.id}`);
            const wholesaleNoteElem = document.getElementById(`wholesale-note-${product.id}`);
            const unitPriceElem = document.getElementById(`unit-price-${product.id}`);
            const unitNoteElem = document.getElementById(`unit-note-${product.id}`);
            const priceMessageElem = document.getElementById(`price-message-${product.id}`);

            // Clear previous dynamic classes for both price elements and message
            [wholesalePriceElem, unitPriceElem].forEach(el => {
                el.classList.remove('text-3xl', 'text-2xl', 'font-bold', 'text-green-600', 'text-blue-600', 'text-base', 'text-gray-500', 'line-through');
            });
            [wholesaleNoteElem, unitNoteElem].forEach(el => {
                el.classList.remove('text-green-600', 'text-blue-600');
                el.classList.add('text-gray-500'); // Ensure default gray for notes
            });
            priceMessageElem.classList.remove('text-green-700', 'text-blue-700', 'font-semibold');
            priceMessageElem.textContent = ''; // Clear previous message

            if (currentQty >= product.wholesaleQuantity && product.wholesaleQuantity > 0) { // Ensure wholesaleQuantity is positive to apply discount
                // If quantity meets wholesale, wholesale price is prominent, unit price is struck through
                wholesalePriceElem.classList.add('text-3xl', 'font-bold', 'text-green-600');
                wholesaleNoteElem.classList.add('text-green-600');
                wholesaleNoteElem.classList.remove('text-gray-500');

                unitPriceElem.classList.add('text-base', 'text-gray-500', 'line-through');
                
                const savingPerUnit = product.unitPrice - product.wholesalePrice;
                priceMessageElem.textContent = `¡Precio Mayorista Aplicado! Ahorras $${formatPrice(savingPerUnit)} por unidad.`;
                priceMessageElem.classList.add('text-green-700', 'font-semibold');

            } else {
                // If quantity is below wholesale, unit price is prominent, wholesale price is struck through
                unitPriceElem.classList.add('text-3xl', 'font-bold', 'text-blue-600');
                unitNoteElem.classList.add('text-blue-600');
                unitNoteElem.classList.remove('text-gray-500');

                if (product.wholesaleQuantity > 0) { // Only show strikethrough and message if wholesale exists
                    wholesalePriceElem.classList.add('text-base', 'text-gray-500', 'line-through');
                    const remainingToWholesale = product.wholesaleQuantity - currentQty;
                    priceMessageElem.textContent = `¡Ahorra! Añade ${remainingToWholesale} ${remainingToWholesale === 1 ? 'unidad' : 'unidades'} más para precio mayorista.`;
                    priceMessageElem.classList.add('text-blue-700', 'font-semibold');
                } else {
                    wholesalePriceElem.classList.remove('text-base', 'text-gray-500', 'line-through'); // Remove if no wholesale
                    wholesalePriceElem.textContent = `$${formatPrice(product.wholesalePrice)}`; // Ensure it shows regular wholesale price
                }
            }
        }


        // --- Cart Management ---
        window.addToCart = async function(productId) {
            const productToAdd = products.find(p => p.id === productId);
            const qtyInput = document.getElementById(`qty-${productId}`);
            const quantity = parseInt(qtyInput.value);

            if (!productToAdd || quantity <= 0) {
                showModal("Atención", "Por favor, selecciona una cantidad válida para añadir al carrito.", [{ text: "Entendido", action: "close" }]);
                return;
            }

            if (quantity > productToAdd.stock) {
                showModal("Sin Stock", `Solo quedan ${productToAdd.stock} unidades de ${productToAdd.name}.`, [{ text: "Entendido", action: "close" }]);
                return;
            }

            // Determine the price based on quantity
            let priceToUse;
            if (quantity >= productToAdd.wholesaleQuantity) {
                priceToUse = productToAdd.wholesalePrice;
            } else {
                priceToUse = productToAdd.unitPrice;
            }

            const itemInCart = cart.find(item => item.productId === productId);

            try {
                const cartCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/cart`);

                if (itemInCart) {
                    // Update existing item in cart
                    const docRef = doc(cartCollectionRef, itemInCart.id);
                    await updateDoc(docRef, {
                        quantity: quantity, // Overwrite with new quantity from input
                        price: priceToUse // Update price in case threshold was crossed
                    });
                    showNotification(`Se actualizó ${quantity} x ${productToAdd.name}`, 'info');
                } else {
                    // Add new item to cart
                    await addDoc(cartCollectionRef, {
                        productId: productId,
                        name: productToAdd.name,
                        price: priceToUse,
                        quantity: quantity,
                        imageUrl: productToAdd.imageUrl
                    });
                    showNotification(`¡AGREGADO! ${quantity} x ${productToAdd.name}`, 'success');
                }
                // Reset quantity input to 0 after adding to cart
                qtyInput.value = 0;
                updateDisplayedPrice(productId); // Reset price display
            } catch (e) {
                console.error("Error adding/updating document: ", e);
                showModal("Error", "No se pudo añadir el producto al carrito. Inténtalo de nuevo.", [{ text: "Cerrar", action: "close" }]);
            }
        };

        function updateCartCount() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCountElement.textContent = totalItems;
        }

        function displayCartContents() {
            currentStep = 0; // Indicate we are in the cart display phase
            if (cart.length === 0) {
                showModal("Tu Carrito", '<p>Tu carrito está vacío.</p>', [{ text: "Cerrar", action: "close" }]);
                return;
            }

            let cartHtml = '<ul class="divide-y divide-gray-200">';
            let total = 0;

            cart.forEach(item => {
                const productDetails = products.find(p => p.id === item.productId); // Get product details for stock
                const maxQuantity = productDetails ? productDetails.stock : item.quantity; // Limit quantity to available stock

                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                cartHtml += `
                    <li class="py-3 flex items-center justify-between">
                        <div class="flex items-center">
                            <img src="${item.imageUrl}" alt="${item.name}" class="w-12 h-12 rounded-md mr-3 object-cover">
                            <div>
                                <p class="font-semibold">${item.name}</p>
                                <p class="text-sm text-gray-600">$${formatPrice(item.price)} / unidad</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <div class="flex items-center border border-gray-300 rounded-md mr-3">
                                <button class="px-2 py-0.5 bg-gray-100 hover:bg-gray-200 rounded-l-md" onclick="updateCartItemQuantity('${item.id}', -1, ${maxQuantity})">-</button>
                                <input type="number" value="${item.quantity}" min="1" max="${maxQuantity}" class="w-12 text-center border-x border-gray-300 appearance-none [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none focus:outline-none" onchange="manualCartItemQuantityUpdate('${item.id}', this.value, ${maxQuantity})">
                                <button class="px-2 py-0.5 bg-gray-100 hover:bg-gray-200 rounded-r-md" onclick="updateCartItemQuantity('${item.id}', 1, ${maxQuantity})">+</button>
                            </div>
                            <span class="font-bold text-gray-800">$${formatPrice(itemTotal)}</span>
                            <button class="ml-3 text-red-500 hover:text-red-700" onclick="removeFromCart('${item.id}', '${item.name}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </li>
                `;
            });

            cartHtml += '</ul>';
            cartHtml += `<div class="mt-4 pt-4 border-t border-gray-200 flex justify-between items-center">
                            <span class="text-lg font-bold">Total:</span>
                            <span class="text-lg font-bold text-blue-600">$${formatPrice(total)}</span>
                          </div>`;

            showModal("Tu Carrito", cartHtml, [
                { text: "Seguir Comprando", action: "close" },
                { text: "Finalizar PEDIDO", action: "custom", className: 'bg-green-600', color: 'text-white', hover: 'hover:bg-green-700', callback: startCheckoutProcess }
            ]);
        }

        window.updateCartItemQuantity = async function(itemId, change, maxQuantity) {
            const itemToUpdate = cart.find(item => item.id === itemId);
            if (!itemToUpdate) return;

            let newQuantity = itemToUpdate.quantity + change;
            newQuantity = Math.max(1, newQuantity); // Minimum quantity is 1
            newQuantity = Math.min(newQuantity, maxQuantity); // Cap at maxQuantity (stock)

            if (newQuantity === itemToUpdate.quantity) {
                return;
            }

            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/cart`, itemId);
                const productDetails = products.find(p => p.id === itemToUpdate.productId);

                let newPrice;
                if (productDetails) {
                    newPrice = newQuantity >= productDetails.wholesaleQuantity ? productDetails.wholesalePrice : productDetails.unitPrice;
                } else {
                    newPrice = itemToUpdate.price;
                }

                await updateDoc(docRef, { quantity: newQuantity, price: newPrice });
                showNotification(`Cantidad de ${itemToUpdate.name} actualizada a ${newQuantity}`, 'info');
            } catch (e) {
                console.error("Error updating cart item quantity: ", e);
                showModal("Error", "No se pudo actualizar la cantidad del producto.", [{ text: "Cerrar", action: "close" }]);
            }
        };

        window.manualCartItemQuantityUpdate = async function(itemId, value, maxQuantity) {
            const itemToUpdate = cart.find(item => item.id === itemId);
            if (!itemToUpdate) return;

            let newQuantity = parseInt(value);
            if (isNaN(newQuantity) || newQuantity < 1) {
                newQuantity = 1; // Default to 1 if invalid input
            }
            newQuantity = Math.min(newQuantity, maxQuantity); // Cap at maxQuantity (stock)

            if (newQuantity === itemToUpdate.quantity) {
                return;
            }

            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/cart`, itemId);
                const productDetails = products.find(p => p.id === itemToUpdate.productId);

                let newPrice;
                if (productDetails) {
                    newPrice = newQuantity >= productDetails.wholesaleQuantity ? productDetails.wholesalePrice : productDetails.unitPrice;
                } else {
                    newPrice = itemToUpdate.price;
                }

                await updateDoc(docRef, { quantity: newQuantity, price: newPrice });
                showNotification(`Cantidad de ${itemToUpdate.name} actualizada a ${newQuantity}`, 'info');
            } catch (e) {
                console.error("Error updating cart item quantity: ", e);
                showModal("Error", "No se pudo actualizar la cantidad del producto.", [{ text: "Cerrar", action: "close" }]);
            }
        };


        window.removeFromCart = async function(itemId, itemName) {
            showModal("Confirmar Eliminación", `¿Estás seguro de que quieres eliminar "${itemName}" del carrito?`, [
                { text: "Cancelar", action: "close" },
                { text: "Eliminar", action: "confirm", callback: async () => {
                    try {
                        const docRef = doc(db, `artifacts/${appId}/users/${userId}/cart`, itemId);
                        await deleteDoc(docRef);
                        showNotification(`¡ELIMINADO! ${itemName}`, 'error');
                    } catch (e) {
                        console.error("Error removing document: ", e);
                        showModal("Error", `No se pudo eliminar "${itemName}" del carrito.`, [{ text: "Cerrar", action: "close" }]);
                    }
                }}
            ]);
        };

        // --- Multi-step Checkout Process ---
        function startCheckoutProcess() {
            checkoutData = {}; // Clear previous data
            currentStep = 1;
            renderCheckoutStep();
        }

        function renderCheckoutStep() {
            let title = `Finalizar PEDIDO - Paso ${currentStep} de ${totalSteps}`;
            let bodyContent = '';
            let buttons = [];

            // Progress indicator
            bodyContent += `<p class="progress-indicator mb-4">Paso ${currentStep} de ${totalSteps}</p>`;

            switch (currentStep) {
                case 1:
                    modalTitle.textContent = title;
                    bodyContent += `
                        <p class="mb-4 font-semibold">Apellido y nombre:</p>
                        <label for="fullName" class="block text-sm font-medium text-gray-700 sr-only">Apellido y Nombre</label>
                        <input type="text" id="fullName" value="${checkoutData.fullName || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: Juan Pérez" required>
                    `;
                    buttons.push({ text: "Siguiente", action: "custom", className: 'bg-blue-600', color: 'text-white', hover: 'hover:bg-blue-700', callback: nextStep });
                    break;
                case 2:
                    modalTitle.textContent = title;
                    bodyContent += `
                        <p class="mb-4 font-semibold">Tipo de entrega:</p>
                        <div class="space-y-2">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="deliveryType" value="Retiro en Local" class="form-radio h-4 w-4 text-blue-600" ${checkoutData.deliveryType === 'Retiro en Local' ? 'checked' : ''}>
                                <span class="ml-2 text-gray-700">Retiro en Local</span>
                            </label>
                            <label class="inline-flex items-center ml-4 cursor-pointer">
                                <input type="radio" name="deliveryType" value="Delivery" class="form-radio h-4 w-4 text-blue-600" ${checkoutData.deliveryType === 'Delivery' ? 'checked' : ''}>
                                <span class="ml-2 text-gray-700">Delivery</span>
                            </label>
                        </div>
                    `;
                    // Add delivery address fields if delivery was previously selected
                    if (checkoutData.deliveryType === 'Delivery') {
                         bodyContent += `
                            <div class="mt-4 p-4 border border-blue-200 bg-blue-50 rounded-md">
                                <p class="mb-2 font-semibold">Datos de envío para Delivery:</p>
                                <label for="deliveryStreet" class="block text-sm font-medium text-gray-700">Calle y Altura</label>
                                <input type="text" id="deliveryStreet" value="${checkoutData.deliveryStreet || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: Av. Rivadavia 1234" required>

                                <label for="deliveryLocation" class="block text-sm font-medium text-gray-700 mt-3">Localidad</label>
                                <input type="text" id="deliveryLocation" value="${checkoutData.deliveryLocation || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: CABA" required>

                                <label for="deliveryZipCode" class="block text-sm font-medium text-gray-700 mt-3">Código Postal</label>
                                <input type="text" id="deliveryZipCode" value="${checkoutData.deliveryZipCode || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: 1406" required>
                            </div>
                        `;
                    }
                    buttons.push({ text: "Anterior", action: "custom", className: 'bg-gray-200', color: 'text-gray-800', hover: 'hover:bg-gray-300', callback: prevStep });
                    buttons.push({ text: "Siguiente", action: "custom", className: 'bg-blue-600', color: 'text-white', hover: 'hover:bg-blue-700', callback: nextStep });
                    break;
                case 3:
                    modalTitle.textContent = title;
                    bodyContent += `
                        <p class="mb-4 font-semibold">Método de pago:</p>
                        <div class="space-y-2">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="paymentMethod" value="Efectivo" class="form-radio h-4 w-4 text-blue-600" ${checkoutData.paymentMethod === 'Efectivo' ? 'checked' : ''}>
                                <span class="ml-2 text-gray-700">Efectivo</span>
                            </label>
                            <label class="inline-flex items-center ml-4 cursor-pointer">
                                <input type="radio" name="paymentMethod" value="Transferencia" class="form-radio h-4 w-4 text-blue-600" ${checkoutData.paymentMethod === 'Transferencia' ? 'checked' : ''}>
                                <span class="ml-2 text-gray-700">Transferencia</span>
                            </label>
                            <label class="inline-flex items-center ml-4 cursor-pointer">
                                <input type="radio" name="paymentMethod" value="Debito/Credito" class="form-radio h-4 w-4 text-blue-600" ${checkoutData.paymentMethod === 'Debito/Credito' ? 'checked' : ''}>
                                <span class="ml-2 text-gray-700">Débito/Crédito</span>
                            </label>
                        </div>
                    `;
                    buttons.push({ text: "Anterior", action: "custom", className: 'bg-gray-200', color: 'text-gray-800', hover: 'hover:bg-gray-300', callback: prevStep });
                    buttons.push({ text: "Siguiente", action: "custom", className: 'bg-blue-600', color: 'text-white', hover: 'hover:bg-blue-700', callback: nextStep });
                    break;
                case 4:
                    modalTitle.textContent = title;
                    bodyContent += `
                        <p class="mb-4 font-semibold">Observaciones:</p>
                        <textarea id="observations" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm h-24" placeholder="Ej: Entregar por la mañana, llamar al llegar, etc.">${checkoutData.observations || ''}</textarea>
                    `;
                    buttons.push({ text: "Anterior", action: "custom", className: 'bg-gray-200', color: 'text-gray-800', hover: 'hover:bg-gray-300', callback: prevStep });
                    buttons.push({ text: "Enviar Pedido", action: "custom", className: 'bg-green-600', color: 'text-white', hover: 'hover:bg-green-700', callback: sendOrderToWhatsApp });
                    break;
            }

            modalBody.innerHTML = bodyContent;
            modalFooter.innerHTML = ''; // Clear existing buttons
            buttons.forEach(btn => {
                const buttonElement = document.createElement('button');
                buttonElement.textContent = btn.text;
                buttonElement.className = 'px-4 py-2 rounded-md transition-colors duration-200 ' + btn.className;
                buttonElement.onclick = btn.callback;
                modalFooter.appendChild(buttonElement);
            });

            customModal.classList.remove('hidden');

            // Add event listeners for radio buttons to update delivery fields dynamically
            if (currentStep === 2) {
                const deliveryRadios = document.querySelectorAll('input[name="deliveryType"]');
                deliveryRadios.forEach(radio => {
                    radio.addEventListener('change', (event) => {
                        checkoutData.deliveryType = event.target.value;
                        renderCheckoutStep(); // Re-render to show/hide address fields
                    });
                });
            }
        }

        function nextStep() {
            if (currentStep === 1) {
                const fullName = document.getElementById('fullName').value.trim();
                if (!fullName) {
                    showModal("Error", "Por favor, ingresa tu Apellido y Nombre.", [{ text: "Entendido", action: "close" }]);
                    return;
                }
                checkoutData.fullName = fullName;
            } else if (currentStep === 2) {
                const selectedDeliveryType = document.querySelector('input[name="deliveryType"]:checked');
                if (!selectedDeliveryType) {
                    showModal("Error", "Por favor, selecciona un tipo de entrega.", [{ text: "Entendido", action: "close" }]);
                    return;
                }
                checkoutData.deliveryType = selectedDeliveryType.value;

                if (checkoutData.deliveryType === 'Delivery') {
                    const street = document.getElementById('deliveryStreet').value.trim();
                    const location = document.getElementById('deliveryLocation').value.trim();
                    const zipCode = document.getElementById('deliveryZipCode').value.trim();
                    if (!street || !location || !zipCode) {
                        showModal("Error", "Por favor, completa todos los datos de envío para Delivery.", [{ text: "Entendido", action: "close" }]);
                        return;
                    }
                    checkoutData.deliveryStreet = street;
                    checkoutData.deliveryLocation = location;
                    checkoutData.deliveryZipCode = zipCode;
                } else {
                    // Clear delivery data if changed from Delivery to Retiro
                    delete checkoutData.deliveryStreet;
                    delete checkoutData.deliveryLocation;
                    delete checkoutData.deliveryZipCode;
                }
            } else if (currentStep === 3) {
                const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
                if (!selectedPaymentMethod) {
                    showModal("Error", "Por favor, selecciona un método de pago.", [{ text: "Entendido", action: "close" }]);
                    return;
                }
                checkoutData.paymentMethod = selectedPaymentMethod.value;
            } else if (currentStep === 4) {
                checkoutData.observations = document.getElementById('observations').value.trim();
                // This is the last step, so send order
                sendOrderToWhatsApp();
                return; // Prevent incrementing currentStep further
            }

            currentStep++;
            renderCheckoutStep();
        }

        function prevStep() {
            currentStep--;
            renderCheckoutStep();
        }

        async function sendOrderToWhatsApp() {
            // Validate final data (should be already done by nextStep, but a final check)
            if (!checkoutData.fullName || !checkoutData.deliveryType || !checkoutData.paymentMethod || cart.length === 0) {
                 showModal("Error", "Faltan datos para completar tu pedido o el carrito está vacío.", [{ text: "Volver", action: "custom", className: 'bg-blue-600', color: 'text-white', hover: 'hover:bg-blue-700', callback: renderCheckoutStep }]);
                 return;
            }

            let orderSummary = `¡Hola! Mi nombre es *${checkoutData.fullName}*.\n\n`;
            orderSummary += `Quiero hacer el siguiente pedido: 👇\n\n`;

            orderSummary += `*📦 Productos:*\n`;
            let totalOrderPrice = 0;
            cart.forEach((item) => {
                const itemTotal = item.price * item.quantity;
                totalOrderPrice += itemTotal;
                orderSummary += `* ${item.name} (${item.quantity}x) - $${formatPrice(item.price)} = *$${formatPrice(itemTotal)}*\n`;
            });

            orderSummary += `\n*💲 Total del Pedido: $${formatPrice(totalOrderPrice)}*\n\n`;

            orderSummary += `*🚚 Método de Entrega:* _${checkoutData.deliveryType}_\n`;
            if (checkoutData.deliveryType === 'Delivery') {
                orderSummary += `_Dirección: ${checkoutData.deliveryStreet}, ${checkoutData.deliveryLocation}, C.P. ${checkoutData.deliveryZipCode}_\n`;
            }
            orderSummary += `*💳 Método de Pago:* _${checkoutData.paymentMethod}_\n\n`;

            if (checkoutData.observations) {
                orderSummary += `*📝 Observaciones:*\n_${checkoutData.observations}_\n\n`;
            }

            orderSummary += `*¡Muchas gracias por tu compra!* 😊`;

            // WhatsApp number
            const whatsappNumber = '5491136013353';
            const whatsappUrl = `whatsapp://send?phone=${whatsappNumber}&text=${encodeURIComponent(orderSummary)}`;

            try {
                // Clear the cart in Firestore after generating the order summary
                const cartRef = collection(db, `artifacts/${appId}/users/${userId}/cart`);
                const q = query(cartRef);
                const querySnapshot = await getDocs(q);
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);

                showNotification("¡PEDIDO ENVIADO!", 'success');
                customModal.classList.add('hidden'); // Close modal
                currentStep = 0; // Reset step
                window.open(whatsappUrl, '_blank'); // Open WhatsApp
            } catch (e) {
                console.error("Error sending order or clearing cart: ", e);
                showModal("Error al Enviar Pedido", "Hubo un problema al procesar tu pedido o al abrir WhatsApp. Inténtalo de nuevo.", [{ text: "Cerrar", action: "close" }]);
            }
        }


        // --- Event Listeners ---
        document.getElementById('hamburger-menu').addEventListener('click', () => {
            document.getElementById('sidebar').classList.add('open');
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('hamburger-menu').classList.add('open');
        });

        document.getElementById('close-sidebar').addEventListener('click', () => {
            closeSidebar();
        });

        document.getElementById('overlay').addEventListener('click', () => {
            closeSidebar();
        });

        document.getElementById('cart-button').addEventListener('click', () => {
            displayCartContents(); // This will show the cart content modal
        });

        document.getElementById('floating-cart-button').addEventListener('click', () => {
            displayCartContents(); // This will show the cart content modal
        });

        // Search bar toggle and input listener
        searchToggleButton.addEventListener('click', () => {
            searchInput.classList.toggle('opacity-0');
            searchInput.classList.toggle('pointer-events-none');
            // If the search bar becomes visible, focus it
            if (!searchInput.classList.contains('opacity-0')) {
                searchInput.focus();
            }
        });

        searchInput.addEventListener('input', (event) => {
            currentSearchQuery = event.target.value.trim();
            activeCategory = 'Todos'; // Reset active category to 'Todos' (show all) when searching
            activeSubcategory = 'Todos'; // Subcategories will be hidden
            isDesktopCategoriesExpanded = false; // Collapse desktop categories when searching
            displayCategories();
            displaySubcategories();
            resetPagination(); // Reset pagination when searching
            renderProductsBasedOnFiltersAndSearch();
        });

        // Filter dropdown toggle
        sortFilterToggle.addEventListener('click', (event) => {
            event.stopPropagation(); // Prevent click from bubbling up to document and closing immediately
            sortFilterDropdown.classList.toggle('hidden');
        });

        // Close filter dropdown when clicking outside
        document.addEventListener('click', (event) => {
            if (!sortFilterDropdown.contains(event.target) && !sortFilterToggle.contains(event.target)) {
                sortFilterDropdown.classList.add('hidden');
            }
        });

        // Ensure search input is visible on larger screens by default
        function checkScreenSizeForSearchInput() {
            if (window.innerWidth >= 1024) { // Equivalent to Tailwind's lg breakpoint
                searchInput.classList.remove('opacity-0', 'pointer-events-none');
                searchInput.classList.add('lg:static', 'lg:translate-y-0', 'lg:w-auto', 'lg:opacity-100', 'lg:pointer-events-auto', 'lg:ml-4');
            } else {
                searchInput.classList.add('opacity-0', 'pointer-events-none');
                searchInput.classList.remove('lg:static', 'lg:translate-y-0', 'lg:w-auto', 'lg:opacity-100', 'lg:pointer-events-auto', 'lg:ml-4');
            }
        }

        // Call on load and on resize
        checkScreenSizeForSearchInput();
        window.addEventListener('resize', checkScreenSizeForSearchInput);
    </script>
</body>
</html>
