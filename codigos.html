<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tu Supermercado Mayorista</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f8f8;
            color: #333;
        }
        /* Custom styles for hamburger menu icon */
        .hamburger {
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            width: 24px;
            height: 24px;
            padding: 0;
            background: transparent;
            border: none;
            z-index: 50;
        }
        .hamburger span {
            display: block;
            width: 100%;
            height: 3px;
            background-color: #333;
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        .hamburger.open span:nth-child(1) {
            transform: translateY(10px) rotate(45deg);
        }
        .hamburger.open span:nth-child(2) {
            opacity: 0;
        }
        .hamburger.open span:nth-child(3) {
            transform: translateY(-10px) rotate(-45deg);
        }

        /* Sidebar styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: -280px; /* Hidden by default */
            width: 280px;
            height: 100%;
            background-color: #fff;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
            transition: left 0.3s ease-in-out;
            z-index: 40;
            padding: 20px;
            overflow-y: auto;
        }
        .sidebar.open {
            left: 0; /* Visible when open */
        }
        .sidebar .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #555;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 30;
            display: none;
        }

        /* Hero section specific styles */
        .hero-banner {
            background: url('https://placehold.co/1200x400/87CEEB/FFFFFF?text=Tu+Supermercado+Mayorista') no-repeat center center/cover;
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }

        /* Category Card (Mobile view, Pill style) */
        .category-card {
            background-color: #e0e7ff; /* Light blue */
            color: #3b82f6; /* Blue 600 */
            padding: 0.75rem 1.25rem;
            border-radius: 9999px; /* Pill shape */
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid transparent; /* For active state */
        }
        .category-card:hover {
            background-color: #c7d2fe; /* Lighter blue on hover */
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .category-card.active {
            background-color: #3b82f6; /* Blue 600 */
            color: white;
            border-color: #1d4ed8; /* Darker blue */
            transform: scale(1.02);
        }

        /* Main Category Link (Desktop view, Text link style in new section) */
        .main-category-link {
            padding: 0.5rem 0.75rem;
            color: #333;
            font-weight: 500;
            text-decoration: none;
            position: relative;
            transition: color 0.3s ease;
            white-space: nowrap; /* Prevent wrapping */
        }
        .main-category-link:hover {
            color: #3b82f6; /* Blue 600 */
        }
        .main-category-link.active {
            color: #1d4ed8; /* Darker blue */
            font-weight: 600;
        }
        .main-category-link.active::after {
            content: '';
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: -5px; /* Adjust as needed */
            width: calc(100% - 1.5rem); /* Adjust based on padding */
            height: 3px;
            background-color: #1d4ed8; /* Darker blue */
            border-radius: 2px;
        }
        /* Separator for desktop main category links */
        .main-category-link + .nav-separator {
            color: #ccc; /* Light gray */
            padding: 0 0.5rem;
            font-size: 1.25rem;
            align-self: center;
        }

        /* Subcategory pills (used in product view) */
        .subcategory-pill {
            background-color: #f0f4f8; /* Light gray-blue */
            color: #4a5568; /* Darker gray */
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 1px solid #cbd5e0; /* border-gray-300 */
            white-space: nowrap; /* Prevent wrapping */
        }
        .subcategory-pill:hover {
            background-color: #e2e8f0; /* Slightly darker on hover */
            transform: translateY(-1px);
        }
        .subcategory-pill.active {
            background-color: #3b82f6; /* Blue 600 */
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3);
        }

        /* View all categories button (desktop) */
        .view-all-categories-btn {
            background: none;
            border: none;
            color: #3b82f6; /* Blue 600 */
            cursor: pointer;
            font-weight: 500;
            padding: 0.5rem 0.75rem;
            transition: color 0.3s ease;
            white-space: nowrap; /* Prevent wrapping */
        }
        .view-all-categories-btn:hover {
            color: #1d4ed8; /* Darker blue */
            text-decoration: underline;
        }

        /* General styles for product view */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        /* Desktop: Force 4 columns on large screens */
        @media (min-width: 1024px) { /* Equivalent to Tailwind's lg: breakpoint */
            .product-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Responsive adjustments for categories section on smaller screens */
        @media (max-width: 767px) {
            .desktop-only {
                display: none;
            }
            .mobile-only {
                display: block;
            }
        }
        @media (min-width: 768px) {
            .mobile-only {
                display: none;
            }
            .desktop-only {
                display: block;
            }
        }

        /* Custom styles for floating cart button */
        .floating-cart-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #3b82f6; /* Blue 600 */
            color: white;
            border-radius: 9999px; /* Fully rounded */
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 50;
            transition: all 0.3s ease;
        }
        .floating-cart-button:hover {
            background-color: #1d4ed8; /* Darker blue */
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0,0,0,0.15);
        }

        /* Notification message styles */
        #notification-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100%); /* Start off-screen */
            z-index: 100;
            padding: 1rem 2rem;
            border-radius: 9999px; /* Pill shape */
            font-weight: 600;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        #notification-message.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Styles for the progress bar (simple text based) */
        .progress-indicator {
            font-size: 0.9rem;
            color: #6b7280; /* gray-500 */
            margin-top: 5px;
            text-align: center;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Notification Message -->
    <div id="notification-message" class="hidden"></div>

    <!-- Top Bar (Header) -->
    <header class="bg-white shadow-md p-4 flex justify-between items-center relative z-20">
        <button class="hamburger" id="hamburger-menu">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <h1 class="text-xl font-bold">Tu Supermercado Mayorista</h1>
        <div class="flex items-center space-x-4">
            <button class="text-gray-600 hover:text-gray-900 focus:outline-none">
                <i class="fas fa-search"></i>
            </button>
            <button class="text-gray-600 hover:text-gray-900 focus:outline-none" id="cart-button">
                <i class="fas fa-shopping-cart"></i>
                <span id="cart-count" class="bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center -ml-2 -mt-2 absolute top-4 right-4 sm:static">0</span>
            </button>
        </div>
    </header>

    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <button class="close-btn" id="close-sidebar">&times;</button>
        <ul class="space-y-4 pt-10">
            <li><a href="#" class="block text-lg font-semibold text-gray-700 hover:text-blue-600">Inicio</a></li>
            <li><a href="#" class="block text-lg font-semibold text-gray-700 hover:text-blue-600">Categorías</a></li>
            <li><a href="#" class="block text-lg font-semibold text-gray-700 hover:text-blue-600">Ofertas</a></li>
            <li><a href="#" class="block text-lg font-semibold text-gray-700 hover:text-blue-600">Contacto</a></li>
            <li><a href="#" class="block text-lg font-semibold text-gray-700 hover:text-blue-600">Mi Cuenta</a></li>
        </ul>
    </nav>

    <!-- Overlay for sidebar -->
    <div class="overlay" id="overlay"></div>

    <main class="flex-grow">
        <!-- Hero Banner Section -->
        <section class="hero-banner h-48 sm:h-64 md:h-80 flex items-center justify-center text-center p-4">
            <div class="container mx-auto">
                <h2 class="text-3xl sm:text-4xl md:text-5xl font-bold mb-2">Grandes Ahorros, Compras al Por Mayor</h2>
                <p class="text-lg sm:text-xl md:text-2xl">Todo lo que necesitas, a precios mayoristas.</p>
            </div>
        </section>

        <!-- Categories Section (Mobile - Pills) -->
        <section class="mobile-only p-4">
            <h3 class="text-xl font-semibold mb-4 text-center">Explora Nuestras Categorías</h3>
            <div id="mobile-categories-container" class="flex flex-wrap justify-center gap-3">
                <!-- Categories will be dynamically loaded here for mobile -->
            </div>
        </section>

        <!-- Categories Section (Desktop - Links) -->
        <section class="desktop-only p-4 bg-white shadow-sm">
            <div class="container mx-auto flex justify-center items-center overflow-x-auto whitespace-nowrap py-2 scrollbar-hide">
                <nav class="flex space-x-2">
                    <button class="view-all-categories-btn" id="view-all-desktop-categories">Ver todas</button>
                    <span class="nav-separator">|</span>
                    <!-- Main categories will be dynamically loaded here for desktop -->
                    <div id="desktop-main-categories-container" class="flex"></div>
                </nav>
            </div>
        </section>

        <!-- Product Listing Section -->
        <section class="p-4 sm:p-6 lg:p-8">
            <div class="container mx-auto">
                <h3 class="text-2xl font-bold mb-6 text-center">Nuestros Productos</h3>
                <!-- Subcategory pills for product filtering -->
                <div id="subcategory-pills-container" class="flex flex-wrap justify-center gap-2 mb-6">
                    <!-- Subcategory pills will be dynamically loaded here -->
                </div>
                <div id="product-list" class="product-grid">
                    <!-- Products will be dynamically loaded here -->
                </div>
            </div>
        </section>
    </main>

    <!-- Floating Cart Button -->
    <button id="floating-cart-button" class="floating-cart-button">
        <i class="fas fa-shopping-cart"></i>
    </button>

    <!-- Custom Modal for Cart Details & Checkout Process -->
    <div id="customModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h4 id="modalTitle" class="text-xl font-bold">Título del Modal</h4>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="modalBody" class="text-gray-700 mb-6 max-h-80 overflow-y-auto">
                <!-- Content will be injected here -->
            </div>
            <div id="modalFooter" class="flex justify-end space-x-4">
                <!-- Buttons will be injected here -->
            </div>
        </div>
    </div>

    <script type="module">
        // Global variables for Firebase config and auth
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // Default userId

        let cart = [];
        const cartCountElement = document.getElementById('cart-count');
        const productListElement = document.getElementById('product-list');
        const mobileCategoriesContainer = document.getElementById('mobile-categories-container');
        const desktopMainCategoriesContainer = document.getElementById('desktop-main-categories-container');
        const subcategoryPillsContainer = document.getElementById('subcategory-pills-container');
        const notificationMessageElement = document.getElementById('notification-message'); // New

        // Modal elements
        const customModal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const modalFooter = document.getElementById('modalFooter');
        const closeModalBtn = document.getElementById('closeModalBtn');

        // Checkout state variables
        let checkoutData = {};
        let currentStep = 0; // 0 for cart display, 1-4 for checkout steps
        const totalSteps = 4; // Total number of checkout steps

        // Product data with wholesale and unit prices
        const products = [
            { id: 'prod1', name: 'Aceite de Girasol', category: 'Aceites y Vinagres', subcategory: 'Aceites', imageUrl: 'https://placehold.co/300x200/FFD700/000000?text=Aceite+Girasol', unitPrice: 2500, wholesalePrice: 2000, wholesaleQuantity: 6, stock: 100, description: 'Aceite de girasol de primera calidad.' },
            { id: 'prod2', name: 'Arroz Largo Fino', category: 'Comestibles', subcategory: 'Arroz y Legumbres', imageUrl: 'https://placehold.co/300x200/C0C0C0/000000?text=Arroz', unitPrice: 1200, wholesalePrice: 900, wholesaleQuantity: 10, stock: 200, description: 'Arroz de grano largo, ideal para guarniciones.' },
            { id: 'prod3', name: 'Leche Entera Larga Vida', category: 'Lácteos y Frescos', subcategory: 'Leches', imageUrl: 'https://placehold.co/300x200/FFFFFF/000000?text=Leche', unitPrice: 1000, wholesalePrice: 750, wholesaleQuantity: 12, stock: 150, description: 'Leche UHT, pack familiar.' },
            { id: 'prod4', name: 'Fideos Secos Tirabuzón', category: 'Comestibles', subcategory: 'Pastas', imageUrl: 'https://placehold.co/300x200/A52A2A/FFFFFF?text=Fideos', unitPrice: 800, wholesalePrice: 600, wholesaleQuantity: 15, stock: 300, description: 'Fideos de trigo candeal, cocción rápida.' },
            { id: 'prod5', name: 'Detergente Líquido', category: 'Limpieza', subcategory: 'Lavandería', imageUrl: 'https://placehold.co/300x200/4682B4/FFFFFF?text=Detergente', unitPrice: 3200, wholesalePrice: 2800, wholesaleQuantity: 4, stock: 80, description: 'Detergente concentrado para ropa.' },
            { id: 'prod6', name: 'Jugo en Polvo Naranja', category: 'Bebidas', subcategory: 'Jugos', imageUrl: 'https://placehold.co/300x200/FFA500/FFFFFF?text=Jugo+Naranja', unitPrice: 500, wholesalePrice: 350, wholesaleQuantity: 20, stock: 250, description: 'Rinde 1 litro, sabor naranja.' },
            { id: 'prod7', name: 'Café Molido Clásico', category: 'Desayuno y Merienda', subcategory: 'Café', imageUrl: 'https://placehold.co/300x200/8B4513/FFFFFF?text=Cafe', unitPrice: 4000, wholesalePrice: 3500, wholesaleQuantity: 5, stock: 90, description: 'Café de tueste medio, aroma intenso.' },
            { id: 'prod8', name: 'Gaseosa Cola', category: 'Bebidas', subcategory: 'Gaseosas', imageUrl: 'https://placehold.co/300x200/B22222/FFFFFF?text=Gaseosa', unitPrice: 1800, wholesalePrice: 1400, wholesaleQuantity: 8, stock: 120, description: 'Refrescante bebida cola, 2.25L.' },
            { id: 'prod9', name: 'Papel Higiénico', category: 'Limpieza', subcategory: 'Papel y Servilletas', imageUrl: 'https://placehold.co/300x200/ADD8E6/000000?text=Papel+Higienico', unitPrice: 5000, wholesalePrice: 4200, wholesaleQuantity: 3, stock: 70, description: 'Paquete de 6 rollos, doble hoja.' },
            { id: 'prod10', name: 'Atún en Lata', category: 'Comestibles', subcategory: 'Enlatados', imageUrl: 'https://placehold.co/300x200/5F9EA0/FFFFFF?text=Atun', unitPrice: 1500, wholesalePrice: 1100, wholesaleQuantity: 10, stock: 110, description: 'Atún en aceite, alto en proteínas.' },
        ];

        // Extract unique categories and subcategories
        const categories = [...new Set(products.map(p => p.category))];
        const subcategories = [...new Set(products.map(p => p.subcategory))];

        let activeCategory = 'Todos'; // Default filter
        let activeSubcategory = 'Todos'; // Default filter

        // --- Firebase Initialization and Authentication ---
        window.onload = async function() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in anonymously or with custom token
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // Listen for auth state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid; // Update userId
                        console.log("Firebase user authenticated:", userId);
                        // Fetch cart data after authentication
                        setupCartListener(userId);
                    } else {
                        userId = crypto.randomUUID(); // Anonymous user ID
                        console.log("Firebase user is anonymous:", userId);
                        setupCartListener(userId); // Still set up listener for anonymous user
                    }
                });

                // Initial display of elements
                displayCategories();
                displaySubcategories();
                displayProducts(products); // Display all products initially

            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                // Fallback: display products without Firebase if error occurs
                displayCategories();
                displaySubcategories();
                displayProducts(products);
                showModal("Error de Conexión", "No se pudo conectar con los servicios de Firebase. Algunas funcionalidades pueden no estar disponibles.", [{ text: "Entendido", action: "close" }]);
            }
        };

        // --- Firebase Cart Listener ---
        function setupCartListener(currentUserId) {
            const cartCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/cart`);
            onSnapshot(cartCollectionRef, (snapshot) => {
                cart = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateCartCount();
                console.log("Cart updated from Firestore:", cart);
                // If cart modal is open and it's the cart view, refresh its content
                if (!customModal.classList.contains('hidden') && currentStep === 0) {
                    displayCartContents();
                }
            }, (error) => {
                console.error("Error listening to cart changes:", error);
                showModal("Error del Carrito", "No se pudieron cargar los datos del carrito en tiempo real.", [{ text: "Cerrar", action: "close" }]);
            });
        }


        // --- UI Helper Functions ---

        // Generic modal show function (used for confirmations and errors)
        function showModal(title, bodyHtml, buttons) {
            modalTitle.innerHTML = title;
            modalBody.innerHTML = bodyHtml;
            modalFooter.innerHTML = ''; // Clear previous buttons

            buttons.forEach(btn => {
                const buttonElement = document.createElement('button');
                buttonElement.textContent = btn.text;
                buttonElement.className = 'px-4 py-2 rounded-md transition-colors duration-200';
                if (btn.action === 'close') {
                    buttonElement.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                    buttonElement.onclick = () => customModal.classList.add('hidden');
                } else if (btn.action === 'confirm') {
                    buttonElement.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                    buttonElement.onclick = () => {
                        btn.callback(); // Execute callback
                        customModal.classList.add('hidden'); // Close after action
                    };
                } else if (btn.action === 'custom') {
                    buttonElement.classList.add(btn.className || 'bg-blue-600', btn.color || 'text-white', btn.hover || 'hover:bg-blue-700');
                    buttonElement.onclick = () => {
                        if (btn.callback) btn.callback();
                        // Modal does not close by default for custom actions, unless callback handles it
                    };
                }
                modalFooter.appendChild(buttonElement);
            });

            customModal.classList.remove('hidden');
        }

        // Close modal button listener
        closeModalBtn.addEventListener('click', () => {
            customModal.classList.add('hidden');
            currentStep = 0; // Reset checkout process if modal is closed manually
        });

        // Function to show temporary notifications
        function showNotification(message, type = 'info') {
            notificationMessageElement.textContent = message;
            notificationMessageElement.classList.remove('hidden', 'bg-red-200', 'text-red-800', 'bg-green-200', 'text-green-800', 'bg-blue-200', 'text-blue-800');
            
            if (type === 'success') {
                notificationMessageElement.classList.add('bg-green-200', 'text-green-800');
            } else if (type === 'error') {
                notificationMessageElement.classList.add('bg-red-200', 'text-red-800');
            } else if (type === 'info') {
                notificationMessageElement.classList.add('bg-blue-200', 'text-blue-800');
            }

            // Trigger show animation
            notificationMessageElement.classList.add('show');

            setTimeout(() => {
                // Trigger hide animation
                notificationMessageElement.classList.remove('show');
                setTimeout(() => {
                    notificationMessageElement.classList.add('hidden'); // Fully hide after transition
                }, 300); // Match transition duration
            }, 1000); // Display for 1 second
        }


        // --- Category Display ---
        function displayCategories() {
            // Mobile Categories (Pills)
            mobileCategoriesContainer.innerHTML = '';
            ['Todos', ...categories].forEach(category => {
                const button = document.createElement('button');
                button.textContent = category;
                button.className = `category-card ${activeCategory === category ? 'active' : ''}`;
                button.onclick = () => filterProductsByCategory(category);
                mobileCategoriesContainer.appendChild(button);
            });

            // Desktop Main Categories (Links)
            desktopMainCategoriesContainer.innerHTML = '';
            ['Todos', ...categories].forEach((category, index) => {
                const link = document.createElement('a');
                link.href = '#';
                link.textContent = category;
                link.className = `main-category-link ${activeCategory === category ? 'active' : ''}`;
                link.onclick = (e) => {
                    e.preventDefault();
                    filterProductsByCategory(category);
                };
                desktopMainCategoriesContainer.appendChild(link);
                if (index < categories.length) { // Don't add separator after the last one
                    const separator = document.createElement('span');
                    separator.textContent = '|';
                    separator.className = 'nav-separator';
                    desktopMainCategoriesContainer.appendChild(separator);
                }
            });

            // "Ver todas" button for desktop
            const viewAllBtn = document.getElementById('view-all-desktop-categories');
            if (viewAllBtn) {
                viewAllBtn.onclick = () => {
                    filterProductsByCategory('Todos');
                };
            }
        }

        // --- Subcategory Display ---
        function displaySubcategories() {
            subcategoryPillsContainer.innerHTML = '';
            let filteredSubcategories = [];
            if (activeCategory === 'Todos') {
                filteredSubcategories = ['Todos', ...subcategories];
            } else {
                filteredSubcategories = ['Todos', ...new Set(products.filter(p => p.category === activeCategory).map(p => p.subcategory))];
            }

            filteredSubcategories.forEach(sub => {
                const button = document.createElement('button');
                button.textContent = sub;
                button.className = `subcategory-pill ${activeSubcategory === sub ? 'active' : ''}`;
                button.onclick = () => filterProductsBySubcategory(sub);
                subcategoryPillsContainer.appendChild(button);
            });
        }

        // --- Price Formatting Function ---
        function formatPrice(price) {
            // Formats number with thousands separator and no decimal places for Argentine locale
            return price.toLocaleString('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        // --- Product Display ---
        function displayProducts(filteredProducts) {
            productListElement.innerHTML = '';
            if (filteredProducts.length === 0) {
                productListElement.innerHTML = '<p class="text-center text-gray-500 col-span-full">No se encontraron productos en esta categoría/subcategoría.</p>';
                return;
            }

            filteredProducts.forEach(product => {
                const productInCart = cart.find(item => item.id === product.id);
                const quantityInCart = productInCart ? productInCart.quantity : 0;

                const productCard = document.createElement('div');
                // Added max-w-sm and min-h-[420px] for consistent card sizing on desktop
                productCard.className = 'bg-white rounded-lg shadow-md overflow-hidden transform transition duration-300 hover:scale-105 flex flex-col max-w-sm min-h-[420px]';
                productCard.innerHTML = `
                    <img src="${product.imageUrl}" alt="${product.name}" class="w-full h-48 object-cover">
                    <div class="p-4 flex-grow">
                        <h4 class="text-lg font-semibold text-gray-800 mb-2">${product.name}</h4>
                        <p class="text-gray-600 text-sm mb-3">${product.description}</p>
                        <div class="flex flex-col mb-4">
                            <!-- Wholesale Price Display -->
                            <div class="flex items-baseline">
                                <span class="product-price-display" id="wholesale-price-${product.id}">
                                    $${formatPrice(product.wholesalePrice)}
                                </span>
                                <span class="ml-2 text-sm text-gray-500" id="wholesale-note-${product.id}">
                                    Mayorista
                                </span>
                            </div>

                            <!-- Unit Price Display -->
                            <div class="flex items-baseline mt-1">
                                <span class="product-price-display" id="unit-price-${product.id}">
                                    $${formatPrice(product.unitPrice)}
                                </span>
                                <span class="ml-2 text-sm text-gray-500" id="unit-note-${product.id}">
                                    por unidad
                                </span>
                            </div>

                            <!-- Dynamic Price Message -->
                            <p id="price-message-${product.id}" class="text-sm mt-2"></p>

                            <!-- Wholesale Quantity Minimum -->
                            <p class="text-xs text-gray-700 mt-2">
                                <span class="font-semibold">Mayorista:</span> a partir de ${product.wholesaleQuantity} unidades.
                            </p>
                        </div>
                        <div class="flex items-center justify-between mt-auto">
                            <div class="flex items-center border border-gray-300 rounded-md">
                                <button class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-l-md" onclick="updateQuantity('${product.id}', -1)">-</button>
                                <input type="number" id="qty-${product.id}" value="${quantityInCart}" min="0" class="w-16 text-center border-x border-gray-300 appearance-none [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none focus:outline-none" onchange="manualQuantityUpdate('${product.id}', this.value)">
                                <button class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-r-md" onclick="updateQuantity('${product.id}', 1)">+</button>
                            </div>
                            <button class="ml-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200" onclick="addToCart('${product.id}')">
                                Añadir
                            </button>
                        </div>
                    </div>
                `;
                productListElement.appendChild(productCard);
                // Update price display immediately after rendering
                updateDisplayedPrice(product.id);
            });
        }

        // --- Filtering Logic ---
        function filterProductsByCategory(category) {
            activeCategory = category;
            activeSubcategory = 'Todos'; // Reset subcategory filter when category changes
            displayCategories();
            displaySubcategories(); // Re-render subcategory pills based on new active category
            filterAndDisplayProducts();
        }

        function filterProductsBySubcategory(subcategory) {
            activeSubcategory = subcategory;
            displaySubcategories();
            filterAndDisplayProducts();
        }

        function filterAndDisplayProducts() {
            let filtered = products;
            if (activeCategory !== 'Todos') {
                filtered = filtered.filter(p => p.category === activeCategory);
            }
            if (activeSubcategory !== 'Todos') {
                filtered = filtered.filter(p => p.subcategory === activeSubcategory);
            }
            displayProducts(filtered);
        }

        // --- Quantity and Price Logic ---
        window.updateQuantity = function(productId, change) {
            const qtyInput = document.getElementById(`qty-${productId}`);
            let currentQty = parseInt(qtyInput.value);
            currentQty = Math.max(0, currentQty + change); // Ensure quantity doesn't go below 0
            qtyInput.value = currentQty;
            updateDisplayedPrice(productId); // Update price display
        };

        window.manualQuantityUpdate = function(productId, value) {
            const qtyInput = document.getElementById(`qty-${productId}`);
            let currentQty = parseInt(value);
            if (isNaN(currentQty) || currentQty < 0) {
                currentQty = 0;
            }
            qtyInput.value = currentQty;
            updateDisplayedPrice(productId); // Update price display
        };

        function updateDisplayedPrice(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const qtyInput = document.getElementById(`qty-${productId}`);
            const currentQty = parseInt(qtyInput.value);

            const wholesalePriceElem = document.getElementById(`wholesale-price-${product.id}`);
            const wholesaleNoteElem = document.getElementById(`wholesale-note-${product.id}`);
            const unitPriceElem = document.getElementById(`unit-price-${product.id}`);
            const unitNoteElem = document.getElementById(`unit-note-${product.id}`);
            const priceMessageElem = document.getElementById(`price-message-${product.id}`);

            // Clear previous dynamic classes for both price elements and message
            [wholesalePriceElem, unitPriceElem].forEach(el => {
                el.classList.remove('text-3xl', 'text-2xl', 'font-bold', 'text-green-600', 'text-blue-600', 'text-base', 'text-gray-500', 'line-through');
            });
            [wholesaleNoteElem, unitNoteElem].forEach(el => {
                el.classList.remove('text-green-600', 'text-blue-600');
                el.classList.add('text-gray-500'); // Ensure default gray for notes
            });
            priceMessageElem.classList.remove('text-green-700', 'text-blue-700', 'font-semibold');
            priceMessageElem.textContent = ''; // Clear previous message

            if (currentQty >= product.wholesaleQuantity) {
                // If quantity meets wholesale, wholesale price is prominent, unit price is struck through
                wholesalePriceElem.classList.add('text-3xl', 'font-bold', 'text-green-600');
                wholesaleNoteElem.classList.add('text-green-600');
                wholesaleNoteElem.classList.remove('text-gray-500');

                unitPriceElem.classList.add('text-base', 'text-gray-500', 'line-through');
                
                const savingPerUnit = product.unitPrice - product.wholesalePrice;
                priceMessageElem.textContent = `¡Precio Mayorista Aplicado! Ahorras $${formatPrice(savingPerUnit)} por unidad.`;
                priceMessageElem.classList.add('text-green-700', 'font-semibold');

            } else {
                // If quantity is below wholesale, unit price is prominent, wholesale price is struck through
                unitPriceElem.classList.add('text-3xl', 'font-bold', 'text-blue-600');
                unitNoteElem.classList.add('text-blue-600');
                unitNoteElem.classList.remove('text-gray-500');

                wholesalePriceElem.classList.add('text-base', 'text-gray-500', 'line-through');
                
                const remainingToWholesale = product.wholesaleQuantity - currentQty;
                priceMessageElem.textContent = `¡Ahorra! Añade ${remainingToWholesale} ${remainingToWholesale === 1 ? 'unidad' : 'unidades'} más para precio mayorista.`;
                priceMessageElem.classList.add('text-blue-700', 'font-semibold');
            }
        }


        // --- Cart Management ---
        window.addToCart = async function(productId) {
            const productToAdd = products.find(p => p.id === productId);
            const qtyInput = document.getElementById(`qty-${productId}`);
            const quantity = parseInt(qtyInput.value);

            if (!productToAdd || quantity <= 0) {
                showModal("Atención", "Por favor, selecciona una cantidad válida para añadir al carrito.", [{ text: "Entendido", action: "close" }]);
                return;
            }

            if (quantity > productToAdd.stock) {
                showModal("Sin Stock", `Solo quedan ${productToAdd.stock} unidades de ${productToAdd.name}.`, [{ text: "Entendido", action: "close" }]);
                return;
            }

            // Determine the price based on quantity
            let priceToUse;
            if (quantity >= productToAdd.wholesaleQuantity) {
                priceToUse = productToAdd.wholesalePrice;
            } else {
                priceToUse = productToAdd.unitPrice;
            }

            const itemInCart = cart.find(item => item.productId === productId);

            try {
                const cartRef = collection(db, `artifacts/${appId}/users/${userId}/cart`);

                if (itemInCart) {
                    // Update existing item in cart
                    const docRef = doc(cartRef, itemInCart.id);
                    await updateDoc(docRef, {
                        quantity: quantity, // Overwrite with new quantity from input
                        price: priceToUse // Update price in case threshold was crossed
                    });
                    showNotification(`Se actualizó ${quantity} x ${productToAdd.name}`, 'info'); // Notification instead of modal
                } else {
                    // Add new item to cart
                    await addDoc(cartRef, {
                        productId: productId,
                        name: productToAdd.name,
                        price: priceToUse, // Store the price at which it was added
                        quantity: quantity,
                        imageUrl: productToAdd.imageUrl
                    });
                    showNotification(`¡AGREGADO! ${quantity} x ${productToAdd.name}`, 'success'); // Notification instead of modal
                }
                // Reset quantity input to 0 after adding to cart
                qtyInput.value = 0;
                updateDisplayedPrice(productId); // Reset price display
            } catch (e) {
                console.error("Error adding/updating document: ", e);
                showModal("Error", "No se pudo añadir el producto al carrito. Inténtalo de nuevo.", [{ text: "Cerrar", action: "close" }]);
            }
        };

        function updateCartCount() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCountElement.textContent = totalItems;
        }

        function displayCartContents() {
            currentStep = 0; // Indicate we are in the cart display phase
            if (cart.length === 0) {
                showModal("Tu Carrito", '<p>Tu carrito está vacío.</p>', [{ text: "Cerrar", action: "close" }]);
                return;
            }

            let cartHtml = '<ul class="divide-y divide-gray-200">';
            let total = 0;

            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                cartHtml += `
                    <li class="py-3 flex items-center justify-between">
                        <div class="flex items-center">
                            <img src="${item.imageUrl}" alt="${item.name}" class="w-12 h-12 rounded-md mr-3 object-cover">
                            <div>
                                <p class="font-semibold">${item.name}</p>
                                <p class="text-sm text-gray-600">${item.quantity} x $${formatPrice(item.price)}</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <span class="font-bold text-gray-800">$${formatPrice(itemTotal)}</span>
                            <button class="ml-3 text-red-500 hover:text-red-700" onclick="removeFromCart('${item.id}', '${item.name}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </li>
                `;
            });

            cartHtml += '</ul>';
            cartHtml += `<div class="mt-4 pt-4 border-t border-gray-200 flex justify-between items-center">
                            <span class="text-lg font-bold">Total:</span>
                            <span class="text-lg font-bold text-blue-600">$${formatPrice(total)}</span>
                          </div>`;

            showModal("Tu Carrito", cartHtml, [
                { text: "Seguir Comprando", action: "close" },
                { text: "Finalizar PEDIDO", action: "custom", className: 'bg-green-600', color: 'text-white', hover: 'hover:bg-green-700', callback: startCheckoutProcess }
            ]);
        }

        window.removeFromCart = async function(itemId, itemName) {
            showModal("Confirmar Eliminación", `¿Estás seguro de que quieres eliminar "${itemName}" del carrito?`, [
                { text: "Cancelar", action: "close" },
                { text: "Eliminar", action: "confirm", callback: async () => {
                    try {
                        const docRef = doc(db, `artifacts/${appId}/users/${userId}/cart`, itemId);
                        await deleteDoc(docRef);
                        showNotification(`¡ELIMINADO! ${itemName}`, 'error'); // Notification instead of modal
                    } catch (e) {
                        console.error("Error removing document: ", e);
                        showModal("Error", `No se pudo eliminar "${itemName}" del carrito.`, [{ text: "Cerrar", action: "close" }]);
                    }
                }}
            ]);
        };

        // --- Multi-step Checkout Process ---
        function startCheckoutProcess() {
            checkoutData = {}; // Clear previous data
            currentStep = 1;
            renderCheckoutStep();
        }

        function renderCheckoutStep() {
            let title = `Finalizar PEDIDO - Paso ${currentStep} de ${totalSteps}`;
            let bodyContent = '';
            let buttons = [];

            // Progress indicator
            bodyContent += `<p class="progress-indicator mb-4">Paso ${currentStep} de ${totalSteps}</p>`;

            switch (currentStep) {
                case 1:
                    modalTitle.textContent = title;
                    bodyContent += `
                        <p class="mb-4 font-semibold">Apellido y nombre:</p>
                        <label for="fullName" class="block text-sm font-medium text-gray-700 sr-only">Apellido y Nombre</label>
                        <input type="text" id="fullName" value="${checkoutData.fullName || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: Juan Pérez" required>
                    `;
                    buttons.push({ text: "Siguiente", action: "custom", className: 'bg-blue-600', color: 'text-white', hover: 'hover:bg-blue-700', callback: nextStep });
                    break;
                case 2:
                    modalTitle.textContent = title;
                    bodyContent += `
                        <p class="mb-4 font-semibold">Tipo de entrega:</p>
                        <div class="space-y-2">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="deliveryType" value="Retiro en Local" class="form-radio h-4 w-4 text-blue-600" ${checkoutData.deliveryType === 'Retiro en Local' ? 'checked' : ''}>
                                <span class="ml-2 text-gray-700">Retiro en Local</span>
                            </label>
                            <label class="inline-flex items-center ml-4 cursor-pointer">
                                <input type="radio" name="deliveryType" value="Delivery" class="form-radio h-4 w-4 text-blue-600" ${checkoutData.deliveryType === 'Delivery' ? 'checked' : ''}>
                                <span class="ml-2 text-gray-700">Delivery</span>
                            </label>
                        </div>
                    `;
                    // Add delivery address fields if delivery was previously selected
                    if (checkoutData.deliveryType === 'Delivery') {
                         bodyContent += `
                            <div class="mt-4 p-4 border border-blue-200 bg-blue-50 rounded-md">
                                <p class="mb-2 font-semibold">Datos de envío para Delivery:</p>
                                <label for="deliveryStreet" class="block text-sm font-medium text-gray-700">Calle y Altura</label>
                                <input type="text" id="deliveryStreet" value="${checkoutData.deliveryStreet || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: Av. Rivadavia 1234" required>

                                <label for="deliveryLocation" class="block text-sm font-medium text-gray-700 mt-3">Localidad</label>
                                <input type="text" id="deliveryLocation" value="${checkoutData.deliveryLocation || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: CABA" required>

                                <label for="deliveryZipCode" class="block text-sm font-medium text-gray-700 mt-3">Código Postal</label>
                                <input type="text" id="deliveryZipCode" value="${checkoutData.deliveryZipCode || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: 1406" required>
                            </div>
                        `;
                    }
                    buttons.push({ text: "Anterior", action: "custom", className: 'bg-gray-200', color: 'text-gray-800', hover: 'hover:bg-gray-300', callback: prevStep });
                    buttons.push({ text: "Siguiente", action: "custom", className: 'bg-blue-600', color: 'text-white', hover: 'hover:bg-blue-700', callback: nextStep });
                    break;
                case 3:
                    modalTitle.textContent = title;
                    bodyContent += `
                        <p class="mb-4 font-semibold">Método de pago:</p>
                        <div class="space-y-2">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="paymentMethod" value="Efectivo" class="form-radio h-4 w-4 text-blue-600" ${checkoutData.paymentMethod === 'Efectivo' ? 'checked' : ''}>
                                <span class="ml-2 text-gray-700">Efectivo</span>
                            </label>
                            <label class="inline-flex items-center ml-4 cursor-pointer">
                                <input type="radio" name="paymentMethod" value="Transferencia" class="form-radio h-4 w-4 text-blue-600" ${checkoutData.paymentMethod === 'Transferencia' ? 'checked' : ''}>
                                <span class="ml-2 text-gray-700">Transferencia</span>
                            </label>
                            <label class="inline-flex items-center ml-4 cursor-pointer">
                                <input type="radio" name="paymentMethod" value="Debito/Credito" class="form-radio h-4 w-4 text-blue-600" ${checkoutData.paymentMethod === 'Debito/Credito' ? 'checked' : ''}>
                                <span class="ml-2 text-gray-700">Débito/Crédito</span>
                            </label>
                        </div>
                    `;
                    buttons.push({ text: "Anterior", action: "custom", className: 'bg-gray-200', color: 'text-gray-800', hover: 'hover:bg-gray-300', callback: prevStep });
                    buttons.push({ text: "Siguiente", action: "custom", className: 'bg-blue-600', color: 'text-white', hover: 'hover:bg-blue-700', callback: nextStep });
                    break;
                case 4:
                    modalTitle.textContent = title;
                    bodyContent += `
                        <p class="mb-4 font-semibold">Observaciones:</p>
                        <textarea id="observations" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm h-24" placeholder="Ej: Entregar por la mañana, llamar al llegar, etc.">${checkoutData.observations || ''}</textarea>
                    `;
                    buttons.push({ text: "Anterior", action: "custom", className: 'bg-gray-200', color: 'text-gray-800', hover: 'hover:bg-gray-300', callback: prevStep });
                    buttons.push({ text: "Enviar Pedido", action: "custom", className: 'bg-green-600', color: 'text-white', hover: 'hover:bg-green-700', callback: sendOrderToWhatsApp });
                    break;
            }

            modalBody.innerHTML = bodyContent;
            modalFooter.innerHTML = ''; // Clear existing buttons
            buttons.forEach(btn => {
                const buttonElement = document.createElement('button');
                buttonElement.textContent = btn.text;
                buttonElement.className = 'px-4 py-2 rounded-md transition-colors duration-200 ' + btn.className;
                buttonElement.onclick = btn.callback;
                modalFooter.appendChild(buttonElement);
            });

            customModal.classList.remove('hidden');

            // Add event listeners for radio buttons to update delivery fields dynamically
            if (currentStep === 2) {
                const deliveryRadios = document.querySelectorAll('input[name="deliveryType"]');
                deliveryRadios.forEach(radio => {
                    radio.addEventListener('change', (event) => {
                        checkoutData.deliveryType = event.target.value;
                        renderCheckoutStep(); // Re-render to show/hide address fields
                    });
                });
            }
        }

        function nextStep() {
            if (currentStep === 1) {
                const fullName = document.getElementById('fullName').value.trim();
                if (!fullName) {
                    showModal("Error", "Por favor, ingresa tu Apellido y Nombre.", [{ text: "Entendido", action: "close" }]);
                    return;
                }
                checkoutData.fullName = fullName;
            } else if (currentStep === 2) {
                const selectedDeliveryType = document.querySelector('input[name="deliveryType"]:checked');
                if (!selectedDeliveryType) {
                    showModal("Error", "Por favor, selecciona un tipo de entrega.", [{ text: "Entendido", action: "close" }]);
                    return;
                }
                checkoutData.deliveryType = selectedDeliveryType.value;

                if (checkoutData.deliveryType === 'Delivery') {
                    const street = document.getElementById('deliveryStreet').value.trim();
                    const location = document.getElementById('deliveryLocation').value.trim();
                    const zipCode = document.getElementById('deliveryZipCode').value.trim();
                    if (!street || !location || !zipCode) {
                        showModal("Error", "Por favor, completa todos los datos de envío para Delivery.", [{ text: "Entendido", action: "close" }]);
                        return;
                    }
                    checkoutData.deliveryStreet = street;
                    checkoutData.deliveryLocation = location;
                    checkoutData.deliveryZipCode = zipCode;
                } else {
                    // Clear delivery data if changed from Delivery to Retiro
                    delete checkoutData.deliveryStreet;
                    delete checkoutData.deliveryLocation;
                    delete checkoutData.deliveryZipCode;
                }
            } else if (currentStep === 3) {
                const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
                if (!selectedPaymentMethod) {
                    showModal("Error", "Por favor, selecciona un método de pago.", [{ text: "Entendido", action: "close" }]);
                    return;
                }
                checkoutData.paymentMethod = selectedPaymentMethod.value;
            } else if (currentStep === 4) {
                checkoutData.observations = document.getElementById('observations').value.trim();
                // This is the last step, so send order
                sendOrderToWhatsApp();
                return; // Prevent incrementing currentStep further
            }

            currentStep++;
            renderCheckoutStep();
        }

        function prevStep() {
            currentStep--;
            renderCheckoutStep();
        }

        async function sendOrderToWhatsApp() {
            // Validate final data (should be already done by nextStep, but a final check)
            if (!checkoutData.fullName || !checkoutData.deliveryType || !checkoutData.paymentMethod || cart.length === 0) {
                 showModal("Error", "Faltan datos para completar tu pedido o el carrito está vacío.", [{ text: "Volver", action: "custom", className: 'bg-blue-600', color: 'text-white', hover: 'hover:bg-blue-700', callback: renderCheckoutStep }]);
                 return;
            }

            let orderSummary = `¡Hola! Mi nombre es *${checkoutData.fullName}*.\n\n`;
            orderSummary += `Quiero hacer el siguiente pedido: 👇\n\n`;

            orderSummary += `*📦 Productos:*\n`;
            let totalOrderPrice = 0;
            cart.forEach((item) => {
                const itemTotal = item.price * item.quantity;
                totalOrderPrice += itemTotal;
                orderSummary += `* ${item.name} (${item.quantity}x) - $${formatPrice(item.price)} = *$${formatPrice(itemTotal)}*\n`;
            });

            orderSummary += `\n*💲 Total del Pedido: $${formatPrice(totalOrderPrice)}*\n\n`;

            orderSummary += `*🚚 Método de Entrega:* _${checkoutData.deliveryType}_\n`;
            if (checkoutData.deliveryType === 'Delivery') {
                orderSummary += `_Dirección: ${checkoutData.deliveryStreet}, ${checkoutData.deliveryLocation}, C.P. ${checkoutData.deliveryZipCode}_\n`;
            }
            orderSummary += `*💳 Método de Pago:* _${checkoutData.paymentMethod}_\n\n`;

            if (checkoutData.observations) {
                orderSummary += `*📝 Observaciones:*\n_${checkoutData.observations}_\n\n`;
            }

            orderSummary += `*¡Muchas gracias por tu compra!* 😊`;

            // WhatsApp number
            const whatsappNumber = '5491136013353';
            const whatsappUrl = `whatsapp://send?phone=${whatsappNumber}&text=${encodeURIComponent(orderSummary)}`;

            try {
                // Clear the cart in Firestore after generating the order summary
                const cartRef = collection(db, `artifacts/${appId}/users/${userId}/cart`);
                const q = query(cartRef);
                const querySnapshot = await getDocs(q);
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);

                showNotification("¡PEDIDO ENVIADO!", 'success');
                customModal.classList.add('hidden'); // Close modal
                currentStep = 0; // Reset step
                window.open(whatsappUrl, '_blank'); // Open WhatsApp
            } catch (e) {
                console.error("Error sending order or clearing cart: ", e);
                showModal("Error al Enviar Pedido", "Hubo un problema al procesar tu pedido o al abrir WhatsApp. Inténtalo de nuevo.", [{ text: "Cerrar", action: "close" }]);
            }
        }


        // --- Event Listeners ---
        document.getElementById('hamburger-menu').addEventListener('click', () => {
            document.getElementById('sidebar').classList.add('open');
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('hamburger-menu').classList.add('open');
        });

        document.getElementById('close-sidebar').addEventListener('click', () => {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('hamburger-menu').classList.remove('open');
        });

        document.getElementById('overlay').addEventListener('click', () => {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('hamburger-menu').classList.remove('open');
        });

        document.getElementById('cart-button').addEventListener('click', () => {
            displayCartContents(); // This will show the cart content modal
        });

        document.getElementById('floating-cart-button').addEventListener('click', () => {
            displayCartContents(); // This will show the cart content modal
        });

        // Initial filtering and display of products on page load
        filterAndDisplayProducts();
    </script>
</body>
</html>
